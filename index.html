<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>구두테스트 퀴즈 - 대수 (Firebase)</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="구두테스트퀴즈">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <style>
    * {
      font-family: 'Noto Sans KR', sans-serif;
    }
    .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }

    /* 수식 렌더링 중에도 화면은 보이도록 */
    #app {
      visibility: visible;
      opacity: 1;
    }

    /* KaTeX 지수 크기 및 위치 조정 */
    .katex .msupsub {
      font-size: 0.75em;
    }

    .katex sup {
      vertical-align: super;
      position: relative;
      top: -0.9em;
    }

    @media (hover: none) and (pointer: coarse) {
      * {
        -webkit-tap-highlight-color: transparent;
        transition: none !important;
      }
      *:active, *:focus, *:hover {
        outline: none !important;
        border-color: inherit !important;
        box-shadow: inherit !important;
        transform: none !important;
      }
    }
  </style>
</head>
<body class="bg-black">
  <div id="app"></div>

  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyCtS_FVlL18WC_ikOWw0Hgl8MSjdH-jSGc",
      authDomain: "ox-quiz-math.firebaseapp.com",
      projectId: "ox-quiz-math",
      storageBucket: "ox-quiz-math.firebasestorage.app",
      messagingSenderId: "1065273366803",
      appId: "1:1065273366803:web:49d4f836f185af67d1e2e6"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    let offlineDB;

    // 관리자 보안 키 (실제 사용시 환경변수나 안전한 곳에 보관)
    const ADMIN_SECRET_KEY = "MATH2025ADMIN";
    const ADMIN_PASSWORD = "teacher2025"; // 관리자 공통 비밀번호

    // 학생 상태: 'active' (재원생), 'withdrawn' (퇴원생)
    
    // 아이콘 SVG
    const icons = {
      user: '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"/>',
      bookOpen: '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2zM22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>',
      chevronLeft: '<path d="m15 18-6-6 6-6"/>',
      chevronRight: '<path d="m9 18 6-6-6-6"/>',
      home: '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2zM9 22V12h6v10"/>',
      barChart: '<path d="M3 3v18h18M18 17V9M13 17V5M8 17v-3"/>',
      award: '<path d="M8.21 13.89 7 23l5-3 5 3-1.21-9.12M15 8A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>',
      lock: '<path d="M7 11V7a5 5 0 0 1 10 0v4M5 11h14a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2Z"/>',
      checkCircle: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4 12 14.01l-3-3"/>',
      xCircle: '<circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/>',
      clock: '<path d="M12 6v6l4 2M22 12A10 10 0 1 1 2 12a10 10 0 0 1 20 0Z"/>',
      users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75M13 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"/>',
      settings: '<circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m6.36 6.36 4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m6.36-6.36 4.24-4.24"/>'
    };

    function icon(type, className = '', size = 24) {
      return `<svg class="${className}" style="width:${size}px;height:${size}px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icons[type]}</svg>`;
    }

    // IndexedDB 초기화
    function initIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('OXQuizDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          offlineDB = request.result;
          resolve(offlineDB);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('pendingData')) {
            db.createObjectStore('pendingData', { keyPath: 'id', autoIncrement: true });
          }
        };
      });
    }

    async function saveToIndexedDB(data) {
      return new Promise((resolve, reject) => {
        const transaction = offlineDB.transaction(['pendingData'], 'readwrite');
        const store = transaction.objectStore('pendingData');
        const request = store.add({
          uid: state.uid,
          data: data,
          timestamp: Date.now()
        });
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    async function deleteFromIndexedDB(id) {
      return new Promise((resolve, reject) => {
        const transaction = offlineDB.transaction(['pendingData'], 'readwrite');
        const store = transaction.objectStore('pendingData');
        const request = store.delete(id);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    async function syncPendingData() {
      try {
        const transaction = offlineDB.transaction(['pendingData'], 'readonly');
        const store = transaction.objectStore('pendingData');
        const request = store.getAll();
        
        request.onsuccess = async () => {
          const pendingItems = request.result;
          
          for (const item of pendingItems) {
            try {
              await db.collection('students').doc(item.uid).set(item.data);
              await deleteFromIndexedDB(item.id);
              console.log('동기화 완료:', item.id);
            } catch (error) {
              console.error('동기화 실패:', error);
            }
          }
          
          if (pendingItems.length > 0) {
            alert(`${pendingItems.length}개의 데이터가 동기화되었습니다!`);
            await loadData(state.uid);
            render();
          }
        };
      } catch (error) {
        console.error('동기화 오류:', error);
      }
    }

    // 카테고리 데이터
    const categories = [
      {
        id: 1,
        name: "Chapter 1. 지수와 로그",
        chapterInfo: [
          { partName: "Part1", description: "지수", range: "Q1~Q20" },
          { partName: "Part2", description: "로그", range: "Q1~Q20" }
        ],
        chapters: [
          { id: 1, name: "Part1. 지수", questions: [
            { question: "Q1. \\(a\\)의 \\(n\\)제곱의 의미와 기호를 쓰시오.", answer: "", hint: "", explanation: "" },
            { question: "Q2. \\(a\\)의 \\(n\\)제곱근의 의미를 설명하시오.<br>\\(a\\)의 \\(n\\)제곱근을 \\(x\\)라 할 때, \\(x\\)에 관한 방정식을 작성하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q3. 다음 물음에 답하시오.<br>(1) \\(8\\)의 세 제곱근을 구하시오.<br>(2) \\(16\\)의 네 제곱근 중 실수인 것을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q4. \\(a\\)의 \\(n\\)제곱근을 \\(x\\)라 하자. \\(n\\)이 홀수일 때, 다음 물음에 답하시오.<br>(그래프를 그려서 설명해야 합니다!)<br>(1) \\(a > 0\\)일 때 실수 \\(x\\)의 개수를 구하시오.<br>(2) \\(a = 0\\)일 때 실수 \\(x\\)의 개수를 구하시오.<br>(3) \\(a < 0\\)일 때 실수 \\(x\\)의 개수를 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q5. \\(a\\)의 \\(n\\)제곱근을 \\(x\\)라 하자. \\(n\\)이 짝수일 때, 다음 물음에 답하시오.<br>(그래프를 그려서 설명해야 합니다!)<br>(1) \\(a > 0\\)일 때 실수 \\(x\\)의 개수를 구하시오.<br>(2) \\(a = 0\\)일 때 실수 \\(x\\)의 개수를 구하시오.<br>(3) \\(a < 0\\)일 때 실수 \\(x\\)의 개수를 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q6. 자연수 \\(n\\) (\\(n \\geq 2\\))에 대하여 실수 \\(a\\)의 \\(n\\)제곱근 중에서 실수인 것의 개수를 \\(f_n(a)\\)라 할 때, \\(f_2(-5) + f_3(-2) + f_4(6)\\)의 값을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q7. 다음 설명 중 옳지 않은 설명을 한 학생을 모두 고르시오.<br>(틀린 이유도 같이 설명하셔야 합니다!)<br><br>채현 : \\(7\\)의 세 제곱근은 \\(\\sqrt[3]{7}\\) 뿐 이야!<br>가람 : \\(-2\\)의 다섯제곱근 중 실수인 것은 \\(1\\)개야!<br>규혁 : \\(n\\)이 짝수일 때, \\(-6\\)의 \\(n\\)제곱근 중 실수인 것은 \\(2\\)개야!<br>다은 : 세 제곱근 \\(\\sqrt[3]{5}\\)와 \\(5\\)의 세 제곱근은 같은 말이야!<br>진 : \\(n\\)이 홀수일 때, \\(x\\)의 \\(n\\)제곱근 중 실수인 것은 항상 \\(1\\)개야!", answer: "", hint: "", explanation: "" },
            { question: "Q8. \\(a > 0\\), \\(b > 0\\)이고 \\(m\\), \\(n\\)이 \\(2\\) 이상인 자연수일 때, 다음이 성립함을 보이시오. (증명하라는 뜻입니다!)<br><br>(1) \\(\\sqrt[n]{a} \\sqrt[n]{b} = \\sqrt[n]{ab}\\)<br><br>(2) \\((\\sqrt[n]{a})^m = \\sqrt[n]{a^m}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q9. \\(x > 0\\)일 때, \\(\\sqrt[4]{\\frac{\\sqrt[3]{x}}{\\sqrt{x}}} \\times \\sqrt[3]{\\frac{\\sqrt{x}}{\\sqrt{x}}} \\times \\sqrt[4]{\\frac{\\sqrt{x}}{\\sqrt[3]{x}}}\\)를 간단히 하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q10. \\(\\sqrt[4]{\\frac{27^{10} + 9^{10}}{27^4 + 9^{11}}}\\)의 값을 구하시오.<br><br>① \\(5\\)<br><br>② \\(6\\)<br><br>③ \\(7\\)<br><br>④ \\(8\\)<br><br>⑤ \\(9\\)", answer: "", hint: "", explanation: "" },
            { question: "Q11. 지수를 유리수의 범위로 확장함에 따라 밑은 양수로 제한이 되어야 하는 이유를 간단한 반례를 들어서 설명하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q12. 다음 값을 구하시오.<br><br>(1) \\((\\frac{1}{2})^0\\)<br><br>(2) \\(3^{-1}\\)<br><br>(3) \\((-2)^{-4}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q13. 다음 식의 값을 구하시오.<br><br>(1) \\(5^{-\\frac{3}{2}} \\times 5^{\\frac{7}{2}}\\)<br><br>(2) \\(\\sqrt[3]{2^2} \\times \\sqrt[3]{\\frac{1}{5}} \\times 10^{\\frac{4}{3}}\\)<br><br>(3) \\(7^{2\\sqrt{3}} \\times 7^{3\\sqrt{3}} \\div 7^{5\\sqrt{3}}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q14. \\(\\sqrt{2} \\sqrt[3]{4} \\sqrt[4]{8} = 2^k\\)일 때, \\(k\\)의 값은 \\(\\frac{p}{q}\\)이다. \\(p+q\\)의 값을 구하시오. (단, \\(p\\)와 \\(q\\)는 서로소이다)<br><br>① \\(47\\)<br><br>② \\(48\\)<br><br>③ \\(49\\)<br><br>④ \\(50\\)<br><br>⑤ \\(51\\)", answer: "", hint: "", explanation: "" },
            { question: "Q15. 세 수 \\(A = \\sqrt[3]{\\sqrt{11}}\\), \\(B = \\sqrt{7}\\), \\(C = \\sqrt{\\sqrt[3]{26}}\\)의 대소관계를 나타내시오.", answer: "", hint: "", explanation: "" },
            { question: "Q16. \\((\\frac{1}{64})^x\\)가 자연수가 되도록 하는 정수 \\(x\\)의 개수는?", answer: "", hint: "", explanation: "" },
            { question: "Q17. \\(x > 0\\)이고, \\(x^{\\frac{1}{2}} + x^{-\\frac{1}{2}} = \\sqrt{11}\\)일 때, \\(x^2 + x^{-2}\\)의 값을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q18. \\(a^{2x} = 3\\)일 때, \\(\\frac{a^x - a^{-x}}{a^x a^{-x}}\\)의 값을 구하시오<br><br>① \\(\\frac{1}{2}\\)<br><br>② \\(1\\)<br><br>③ \\(\\frac{3}{2}\\)<br><br>④ \\(2\\)<br><br>⑤ \\(\\frac{5}{2}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q19. 실수 \\(x\\), \\(y\\)에 대하여 \\(5^x = 20^y = 4\\)일 때, \\(\\frac{1}{x} - \\frac{1}{y}\\)의 값을 구하시오.<br><br>① \\(-2\\)<br><br>② \\(-1\\)<br><br>③ \\(0\\)<br><br>④ \\(1\\)<br><br>⑤ \\(2\\)", answer: "", hint: "", explanation: "" },
            { question: "Q20. \\(3^x = 5^y = 15^z\\)일 때, \\(\\frac{1}{x} + \\frac{1}{y} - \\frac{1}{z}\\)의 값은?<br><br>① \\(-2\\)<br><br>② \\(-1\\)<br><br>③ \\(0\\)<br><br>④ \\(1\\)<br><br>⑤ \\(2\\)", answer: "", hint: "", explanation: "" }
          ]},
          { id: 2, name: "Part2. 로그", questions: [
            { question: "Q1. \\(a^x = N\\)일 때, \\(x\\)를 로그에 관한 식으로 표현하시오.<br>또한, \\(a\\)와 \\(N\\)의 값의 범위를 상세하게 적으시오.", answer: "", hint: "", explanation: "" },
            { question: "Q2. 다음 물음에 답하시오.<br><br>(1) \\(\\log_a b\\)에서 \\(a\\) ≠ \\(1\\)인 이유를 예를 들어 간단히 설명하시오.<br><br>(2) \\(\\log_a b\\)에서 \\(b\\) > \\(0\\)인 이유를 간단히 설명하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q3. \\(\\log_{x-1}(-x^2 + 4x + 5)\\)가 정의되기 위한 모든 정수 \\(x\\)의 합을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q4. 로그의 성질에서 다음이 성립함을 보이시오. (유도해보세요!)<br><br>\\(\\log_a MN = \\log_a M + \\log_a N\\)", answer: "", hint: "", explanation: "" },
            { question: "Q5. 로그의 성질에서 다음이 성립함을 보이시오. (유도해보세요!)<br><br>\\(\\log_a M^k = k \\log_a M\\) (단, \\(k\\)는 실수)", answer: "", hint: "", explanation: "" },
            { question: "Q6. 다음 식을 간단히 하시오.<br><br>(1) \\(\\log_4 4 + \\log_3 1 - \\log_5 \\frac{1}{5}\\)<br><br>(2) \\(\\log_3 72 + 3\\log_3 \\frac{3}{2}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q7. \\(\\log_{10} 2 = a\\), \\(\\log_{10} 3 = b\\)일 때, \\(\\log_{10} 450\\)을 \\(a\\)와 \\(b\\)에 관한 식으로 표현한 것은?<br><br>① \\(a+b-1\\)<br>② \\(a+2b-2\\)<br>③ \\(-a+b+1\\)<br>④ \\(-a-b+2\\)<br>⑤ \\(-a+2b+2\\)", answer: "", hint: "", explanation: "" },
            { question: "Q8. 이차방정식 \\(x^2 - 3x + 1 = 0\\)의 두 근이 \\(\\log_2 a\\), \\(\\log_2 b\\)일 때, \\(ab\\)의 값을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q9. \\(\\log_2(1 + \\frac{1}{1}) + \\log_2(1 + \\frac{1}{2}) + \\log_2(1 + \\frac{1}{3}) + \\cdots + \\log_2(1 + \\frac{1}{31})\\)의 값을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q10. 로그의 밑 변환 공식을 쓰고, 그 쓰임새에 대하여 간단히 말해보시오.", answer: "", hint: "", explanation: "" },
            { question: "Q11. 다음 식의 값을 계산하시오.<br><br>(1) \\(5^{\\log_5 20}\\)<br><br>(2) \\(\\log_3 4 \\times \\log_4 5 \\times \\log_5 6\\)<br><br>(3) \\(36^{\\log_6 4}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q12. \\(10\\)이 아닌 양수 \\(x\\)에 대하여 \\(\\frac{1}{\\log_3 x} + \\frac{1}{\\log_5 x} + \\frac{1}{\\log_7 x} = \\frac{1}{\\log_a x}\\)일 때, 양수 \\(a\\)의 값을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q13. \\(\\log_{10}(\\log_2 3) + \\log_{10}(\\log_3 4) + \\log_{10}(\\log_4 5) + \\cdots + \\log_{10}(\\log_{511} 512)\\)의 값은?<br><br>① \\(\\log_{10} 8\\)<br><br>② \\(\\log_{10} 9\\)<br><br>③ \\(1\\)<br><br>④ \\(2\\)<br><br>⑤ \\(10\\)", answer: "", hint: "", explanation: "" },
            { question: "Q14. \\(a = 10^x\\), \\(b = 10^y\\)일 때, \\(\\log_a b^2\\)를 \\(x\\), \\(y\\)에 대한 식으로 표현한 것은?<br><br>① \\(\\frac{y}{3x}\\)<br><br>② \\(\\frac{3y}{x}\\)<br><br>③ \\(\\frac{y}{x}\\)<br><br>④ \\(\\frac{y}{6x}\\)<br><br>⑤ \\(\\frac{6y}{x}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q15. \\(3^x = 4^y = 144\\)를 만족하는 실수 \\(x\\), \\(y\\)에 대하여 \\(\\frac{1}{x} + \\frac{1}{y}\\)의 값은?<br><br>① \\(\\frac{1}{4}\\)<br><br>② \\(\\frac{1}{2}\\)<br><br>③ \\(1\\)<br><br>④ \\(2\\)<br><br>⑤ \\(4\\)", answer: "", hint: "", explanation: "" },
            { question: "Q16. \\(9^{\\log_3 25 + \\log_{\\sqrt{3}} 4 - \\log_3 400}\\)의 값을 계산하시오.<br><br>① \\(1\\)<br><br>② \\(9\\)<br><br>③ \\(81\\)<br><br>④ \\(\\frac{1}{9}\\)<br><br>⑤ \\(\\frac{1}{3}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q17. 상용로그의 정의와 일상생활에서 상용로그를 쓰는 이유를 간단하게 설명해보시오.", answer: "", hint: "", explanation: "" },
            { question: "Q18. \\(\\log 4.16 = 0.6191\\), \\(\\log 8.87 = 0.9479\\)일 때, 다음 값을 구하시오.<br><br>(1) \\(\\log 4160\\)<br><br>(2) \\(\\log 0.0887\\)", answer: "", hint: "", explanation: "" },
            { question: "Q19. \\(\\log 76.1 = 1.8814\\)임을 이용하여, \\(\\log x = -1.1186\\)을 만족하는 \\(x\\)의 값을 바르게 구한 것은?<br><br>① \\(761\\)<br><br>② \\(7610\\)<br><br>③ \\(0.761\\)<br><br>④ \\(0.0761\\)<br><br>⑤ \\(0.00761\\)", answer: "", hint: "", explanation: "" },
            { question: "Q20. \\(\\log 24300\\)에 대하여 바르게 설명한 학생을 모두 고르시오.<br><br>유경 : 밑이 생략되어 있으므로 상용로그야!<br>윤후 : 정수부분은 \\(4\\)야!<br>미래 : 아니지~!! 정수부분은 \\(5\\)야!<br>시현 : 소수부분은 \\(\\log 243\\)이야!<br>윤영 : 아니야! 소수부분은 \\(\\log 24.3\\)이야!", answer: "", hint: "", explanation: "" }
          ]}
        ]
      },
      {
        id: 2,
        name: "Chapter 2. 지수함수와 로그함수",
        chapterInfo: [
          { partName: "Part1", description: "지수함수의 그래프", range: "Q1~Q20" },
          { partName: "Part2", description: "로그함수의 그래프", range: "Q1~Q23" },
          { partName: "Part3", description: "지수함수의 활용", range: "Q1~Q6" },
          { partName: "Part4", description: "로그함수의 활용", range: "Q1~Q7" }
        ],
        chapters: [
          { id: 1, name: "Part1. 지수함수의 그래프", questions: [
            { question: "Q1. \\(y = a^x\\)에 대한 다음 설명 중 틀린 설명을 한 학생을 모두 고르시오. (설명이 틀린 학생이 있다면 이유도 말하셔야 됩니다!)<br><br>성희 : 정의역은 실수 전체의 집합이야!<br>상일 : 치역도 실수 전체의 집합이야!<br>채현 : \\(x\\)의 값이 증가하면 \\(y\\)의 값도 증가하는 함수야!<br>다은 : \\(y\\)축을 점근선으로 가지는 함수야!<br>영우 : \\(y = (\\frac{1}{a})^x\\)의 그래프와 \\(x\\)축에 대하여 대칭이야!<br>시현 : \\(a\\)의 값에 관계없이 항상 \\((0, 1)\\)을 지나는 함수야!", answer: "", hint: "", explanation: "" },
            { question: "Q2. \\(y = a^x\\)에서 \\(a\\) > \\(0\\), \\(a\\) ≠ \\(1\\)인 이유를 간단하게 설명하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q3. 함수 \\(f(x) = a^{mx+n}\\) (\\(a > 0\\), \\(a \\neq 1\\))에서 \\(f(0) = 3\\), \\(f(-1) = \\frac{1}{3}\\)일 때, \\(f(1)\\)의 값을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q4. 함수 \\(y = (a^2 - 5a - 5)^x\\)에서 \\(x\\)의 값이 증가할 때, \\(y\\)의 값이 증가하도록 하는 자연수 \\(a\\)의 최댓값을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q5. \\(f(x) = (\\frac{1}{3})^x\\)에 대한 다음 설명 중 옳은 설명을 한 학생을 모두 고르시오. (설명이 틀린 학생이 있다면 이유도 말하셔야 됩니다!)<br><br>진 : \\(f(x) = 0\\)인 실수 \\(x\\)가 존재해!<br>가람 : 정의역은 양의 실수 전체의 집합이야!<br>규혁 : 두 실수 \\(x\\), \\(y\\)에 대하여 \\(f(x+y) = f(x)f(y)\\)를 만족해!<br>미래 : \\(x_1 < x_2\\)이면 \\(f(x_1) < f(x_2)\\)를 만족해!<br>다연 : \\(y = 3^x\\)의 그래프와 \\(x\\)축에 대하여 대칭이야!", answer: "", hint: "", explanation: "" },
            { question: "Q6. 세 수 \\(A = 2^{\\frac{1}{3}}\\), \\(B = (0.25)^{-2}\\), \\(C = \\sqrt[3]{4^2}\\)의 대소 관계를 지수함수의 그래프를 이용하여 비교하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q7. 함수 \\(y = a^{x-m} + n\\)에 대하여 다음 물음에 답하시오.<br><br>1. 정의역을 구하시오<br><br>2. 치역을 구하시오<br><br>3. 점근선의 방정식을 구하시오<br><br>4. \\(a\\)의 값에 관계없이 항상 지나는 정점을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q8. 다음 함수의 그래프를 조건에 맞게 그리시오.<br><br>1. 그래프의 점근선이 표시되게 그릴 것<br>2. \\(y\\)절편이 표시되게 그릴 것<br><br>(1) \\(y = 2^{x-1} + 3\\)<br><br>(2) \\(y = (\\frac{1}{5})^{x+2} - 4\\)<br><br>(3) \\(y = -(\\frac{1}{4})^{2x-2} + 5\\)", answer: "", hint: "", explanation: "" },
            { question: "Q9. 함수 \\(y = 4^x\\)의 그래프를 \\(x\\)축의 방향으로 \\(a\\)만큼, \\(y\\)축의 방향으로 \\(b\\)만큼 평행이동하였더니 함수 \\(y = \\frac{1}{16} \\times 4^x - 7\\)의 그래프와 겹쳐졌다. 이때 \\(a+b\\)의 값은?<br><br>① \\(-9\\)<br><br>② \\(-8\\)<br><br>③ \\(-7\\)<br><br>④ \\(-6\\)<br><br>⑤ \\(-5\\)", answer: "", hint: "", explanation: "" },
            { question: "Q10. 함수 \\(y = 5^x\\)의 그래프를 평행이동 또는 대칭이동하여 겹쳐질 수 있는 그래프의 식만을 고른 것은?<br><br>ㄱ. \\(y = (\\frac{1}{5})^{x-4}\\)<br><br>ㄴ. \\(y = -5^{x+2} - 3\\)<br><br>ㄷ. \\(y = 5^{2x+6}\\)<br><br>ㄹ. \\(y = 9 \\times 5^x + 1\\)", answer: "", hint: "", explanation: "" },
            { question: "Q11. 함수 \\(y = 2^{-x+3} + k\\)의 그래프가 제 \\(3\\)사분면을 지나도록 하는 정수 \\(k\\)의 최댓값은?<br><br>① \\(-9\\)<br><br>② \\(-8\\)<br><br>③ \\(-7\\)<br><br>④ \\(-6\\)<br><br>⑤ \\(-5\\)", answer: "", hint: "", explanation: "" },
            { question: "Q12. 함수 \\(y = \\sqrt{3} \\times 7^x - 2\\)의 그래프가 \\(y = 7^{x+a} + b\\)의 그래프와 일치할 때, \\(ab\\)의 값은?<br><br>① \\(\\log_7 2\\)<br><br>② \\(\\log_7 3\\)<br><br>③ \\(\\log_7 6\\)<br><br>④ \\(-\\log_7 3\\)<br><br>⑤ \\(-\\log_7 6\\)", answer: "", hint: "", explanation: "" },
            { question: "Q13. 정의역이 \\(\\{x \\mid -2 \\leq x \\leq 1\\}\\)인 함수 \\(y = \\left(\\frac{1}{2}\\right)^{x+3} - 1\\)의 최댓값을 \\(M\\) 최솟값을 \\(m\\)이라 했을 때, \\(Mm\\)의 값은?<br><br>① \\(\\frac{15}{4}\\)<br><br>② \\(\\frac{15}{8}\\)<br><br>③ \\(\\frac{15}{16}\\)<br><br>④ \\(\\frac{15}{32}\\)<br><br>⑤ \\(\\frac{15}{64}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q14. 정의역이 \\(\\{x \\mid -3 \\leq x \\leq 2\\}\\)인 함수 \\(y = 2^{x^2 + 4x - 5}\\)의 최댓값을 \\(M\\) 최솟값을 \\(m\\)이라 했을 때, \\(Mm\\)의 값은?<br><br>① \\(\\frac{1}{8}\\)<br><br>② \\(\\frac{1}{4}\\)<br><br>③ \\(\\frac{1}{2}\\)<br><br>④ \\(2\\)<br><br>⑤ \\(4\\)", answer: "", hint: "", explanation: "" },
            { question: "Q15. 함수 \\(y = 4^x - 2^{x+2} + 10\\) \\((0 \\leq x \\leq 2)\\)의 최댓값과 최솟값의 합은?<br><br>① \\(14\\)<br><br>② \\(15\\)<br><br>③ \\(16\\)<br><br>④ \\(17\\)<br><br>⑤ \\(18\\)", answer: "", hint: "", explanation: "" },
            { question: "Q16. 정의역이 \\(\\{x \\mid -1 \\leq x \\leq 2\\}\\)인 함수 \\(f(x) = \\left(\\frac{5}{a}\\right)^x\\)의 최댓값이 \\(4\\)가 되도록 하는 모든 양수 \\(a\\)의 값의 곱을 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q17. 정의역이 \\(\\{x \\mid 0 \\leq x \\leq 3\\}\\)인 함수 \\(y = a^{x^2 - 2x + 4}\\)의 최솟값이 \\(\\frac{1}{128}\\)일 때, 상수 \\(a\\)의 값은? (단, \\(0 < a < 1\\))<br><br>① \\(\\frac{1}{32}\\)<br><br>② \\(\\frac{1}{16}\\)<br><br>③ \\(\\frac{1}{8}\\)<br><br>④ \\(\\frac{1}{4}\\)<br><br>⑤ \\(\\frac{1}{2}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q18. 함수 \\(y = \\left(\\frac{1}{4}\\right)^x - k\\left(\\frac{1}{2}\\right)^{x-2} + 3\\)의 최솟값이 \\(-1\\)일 때, 양수 \\(k\\)의 값은?<br><br>① \\(1\\)<br><br>② \\(2\\)<br><br>③ \\(3\\)<br><br>④ \\(4\\)<br><br>⑤ \\(5\\)", answer: "", hint: "", explanation: "" },
            { question: "Q19. \\(a^x + a^{-x}\\)의 최솟값 \\(2\\)인데 그 이유랑 \\(a^x - a^{-x}\\) = 실수전체 인 이유를 설명하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q20. 함수 \\(y = 5(2^x + 2^{-x}) - (4^x + 4^{-x})\\)의 최댓값은 \\(\\frac{n}{m}\\)이다. \\(m+n\\)의 값은? (단, \\(m\\), \\(n\\)은 상수)", answer: "", hint: "", explanation: "" }
          ]},
          { id: 2, name: "Part2. 로그함수의 그래프", questions: [
            { question: "Q1. 지수함수에서 로그함수가 나온 과정을 역함수의 개념을 도입하여 설명하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q2. 다음은 로그함수 \\(y = \\log_a x\\) (\\(a\\) > \\(0\\), \\(a\\) ≠ \\(1\\))에 관한 학생들의 대화이다. 틀은 설명을 한 학생을 고르시오. (틀린 이유도 말해야 합니다!)<br><br>다은 : 정의역은 양의 실수 전체의 집합이야!<br>윤후 : 치역은 \\(0\\)을 제외한 실수 전체의 집합이야!<br>상일 : \\(a\\)의 값에 관계없이 항상 \\((1, 0)\\)을 지나네~<br>준희 : \\(x\\)축을 점근선으로 가지는 함수야!<br>채현 : \\(y = a^x\\)와 역함수의 관계야!<br>성희 : \\(y = \\log_{\\frac{1}{a}} x\\)의 그래프와 \\(y\\)축에 대하여 대칭이야!", answer: "", hint: "", explanation: "" },
            { question: "Q3. 함수 \\(f(x) = \\log_a(x-2) + 4\\)에 대하여 \\(f(5) = 7\\)일 때, \\(f(11)\\)의 값은?", answer: "", hint: "", explanation: "" },
            { question: "Q4. 함수 \\(f(x) = \\log_2 x - k\\log_4 4\\)에 대하여 \\(f(4) = f(16)\\)일 때, 상수 \\(k\\)의 값은?<br><br>① \\(-1\\)<br><br>② \\(-2\\)<br><br>③ \\(-3\\)<br><br>④ \\(-4\\)<br><br>⑤ \\(-5\\)", answer: "", hint: "", explanation: "" },
            { question: "Q5. 세 함수 \\(y = \\log_2 x^2\\), \\(y = 2\\log_2 x\\), \\(y = 2\\log_2 |x|\\)가 있다.<br>다음 물음에 답하시오. (이유를 상세히 설명해야 합니다!)<br><br>(1) \\(y = \\log_2 x^2\\)과 \\(y = 2\\log_2 x\\)는 서로 같은 함수인가?<br><br>(2) \\(y = \\log_2 x^2\\)과 \\(y = 2\\log_2 |x|\\)는 서로 같은 함수인가?", answer: "", hint: "", explanation: "" },
            { question: "Q6. 다음은 여러 가지 로그함수의 그래프를 나타낸 것이다.<br>\\(a\\), \\(b\\), \\(c\\), \\(d\\)의 대소관계를 나타내시오. (단, \\(a\\), \\(b\\), \\(c\\), \\(d\\)는 상수이다.)<br><br><img src='images/part4_q6_graph.png' alt='여러 로그함수 그래프' style='max-width: 400px; margin: 10px 0;'>", answer: "", hint: "", explanation: "" },
            { question: "Q7. 아래 그림과 같이 \\(y = \\log_2 x\\)의 그래프 위의 점 \\(A\\)에 대하여<br>사각형 \\(ABCD\\)는 한 변의 길이가 \\(3\\)인 정사각형이다. 이 때 점 \\(D\\)의<br>좌표는 \\((a, b)\\)이다. \\(a+b\\)의 값은? (단, \\(a\\), \\(b\\)는 상수이다.)<br><br><img src='images/part4_q7_graph.png' alt='로그함수와 정사각형' style='max-width: 400px; margin: 10px 0;'>", answer: "", hint: "", explanation: "" },
            { question: "Q8. 함수 \\(y = \\log_3 x\\)와 같은 함수인 것만을 보기에서 있는대로 고른 것은?<br><br>ㄱ. \\(y = \\log_{\\frac{1}{3}}(-x)\\)<br><br>ㄴ. \\(y = -\\log_3\\frac{1}{x}\\)<br><br>ㄷ. \\(y = \\log_9 x^2\\)<br><br>ㄹ. \\(y = -2\\log_{\\frac{1}{9}} x\\)", answer: "", hint: "", explanation: "" },
            { question: "Q9. 로그함수 \\(y = \\log_a(x-m)+n\\)의 그래프에 대하여<br>다음 물음에 답하시오.<br><br>(1) 정의역<br><br>(2) 치역<br><br>(3) 점근선<br><br>(4) \\(a\\)의 값에 관계없이 항상 지나는 정점", answer: "", hint: "", explanation: "" },
            { question: "Q10. 다음 함수의 그래프를 그리고, 점근선을 구하시오.<br><br>(1) \\(y = \\log_2(x+1) - 3\\)<br><br>(2) \\(y = \\log_{\\frac{1}{3}}(-2x+6) + 4\\)<br><br>(3) \\(y = -\\log_2(-x+5) + 1\\)", answer: "", hint: "", explanation: "" },
            { question: "Q11. 로그함수의 그래프에 관한 설명 중 옳은 것을 고르시오.<br>(틀린 보기가 있다면 틀린 이유도 말하셔야 합니다!)<br><br>ㄱ. \\(y = \\log_a x\\)의 그래프와 \\(y = \\log_a \\frac{1}{x}\\)의 그래프는 \\(y\\)축 대칭이다.<br><br>ㄴ. \\(y = \\log_a(-x)\\)의 그래프와 \\(y = -\\log_a(-x)\\)의 그래프는 \\(x\\)축 대칭이다.<br><br>ㄷ. \\(y = \\log_a x\\)의 그래프와 \\(y = -\\log_a(-x)\\)의 그래프는 원점 대칭이다.", answer: "", hint: "", explanation: "" },
            { question: "Q12. 로그함수 \\(y = \\log_{\\frac{1}{2}}(7x)\\)의 그래프는 \\(y = \\log_{\\frac{1}{2}} x\\)의 그래프를 \\(y\\)축의 방향으로 \\(b\\)만큼 평행이동한 그래프이다. \\(b\\)의 값은? (단, \\(k\\)는 상수이다.)", answer: "", hint: "", explanation: "" },
            { question: "Q13. 함수 \\(y = \\log_2(x+a)+b\\)의 그래프가 아래 그림과 같을 때,<br>\\(a+b\\)의 값을 구하시오. (단, \\(a\\), \\(b\\)는 상수이다.)<br><br><img src='images/part4_q13_graph.png' alt='로그함수 그래프' style='max-width: 400px; margin: 10px 0;'>", answer: "", hint: "", explanation: "" },
            { question: "Q14. 아래 그림과 같이 두 함수 \\(y = \\log_3 x\\), \\(y = \\log_3 9x\\)의 그래프와<br>두 직선 \\(x=1\\), \\(x=9\\)로 둘러싸인 도형의 넓이를 구하시오.<br><br><img src='images/part4_q14_graph.png' alt='두 로그함수 사이 넓이' style='max-width: 400px; margin: 10px 0;'>", answer: "", hint: "", explanation: "" },
            { question: "Q15. 정의역이 \\(\\{x \\mid 8 \\leq x \\leq 22\\}\\)인 함수 \\(f(x) = \\log_{\\frac{1}{2}}(x-6)\\)의<br>최댓값을 \\(M\\), 최솟값을 \\(m\\)이라 할 때, \\(M-m\\)의 값은?", answer: "", hint: "", explanation: "" },
            { question: "Q16. 정의역이 \\(\\{x \\mid 2 \\leq x \\leq 5\\}\\)인 함수 \\(f(x) = \\log_{\\frac{1}{3}}(-x^2 + 6x)\\)의<br>최댓값을 \\(M\\), 최솟값을 \\(m\\)이라 할 때, \\(Mm\\)의 값은?<br><br>① \\(\\log_3 5\\)<br><br>② \\(2\\log_3 5\\)<br><br>③ \\(3\\log_3 5\\)<br><br>④ \\(4\\log_3 5\\)<br><br>⑤ \\(5\\log_3 5\\)", answer: "", hint: "", explanation: "" },
            { question: "Q17. 정의역이 \\(\\{x \\mid 1 \\leq x \\leq 81\\}\\)인 함수 \\(y = (\\log_3 x)(\\log_{\\frac{1}{3}} x) + 2\\log_3 x + 7\\)의<br>최댓값을 \\(M\\), 최솟값을 \\(m\\)이라 할 때, \\(M+m\\)의 값은?<br><br>① \\(3\\)<br><br>② \\(4\\)<br><br>③ \\(5\\)<br><br>④ \\(6\\)<br><br>⑤ \\(7\\)", answer: "", hint: "", explanation: "" },
            { question: "Q18. 정의역이 \\(\\{x \\mid 1 \\leq x \\leq 81\\}\\)인 함수 \\(y = x^{\\log_3 x - 6}\\)의<br>최댓값을 \\(M\\), 최솟값을 \\(m\\)이라 할 때, \\(Mm\\)의 값은?<br><br>① \\(3^{-9}\\)<br><br>② \\(3^{-8}\\)<br><br>③ \\(3^{-7}\\)<br><br>④ \\(3^{-6}\\)<br><br>⑤ \\(3^{-5}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q19. \\(\\log_2\\left(2a + \\frac{1}{b}\\right) + \\log_2\\left(b + \\frac{4}{2a}\\right)\\)의 최솟값을 구하시오.<br>(단, \\(a > 0\\), \\(b > 0\\))<br><br>① \\(\\log_2 3\\)<br><br>② \\(2\\log_2 3\\)<br><br>③ \\(3\\log_2 3\\)<br><br>④ \\(4\\log_2 3\\)<br><br>⑤ \\(5\\log_2 3\\)", answer: "", hint: "", explanation: "" },
            { question: "Q20. 방정식 \\(2^{x-1} = \\log_2 x + 1\\)의 해를 구하는 과정을 보이시오.", answer: "", hint: "", explanation: "" },
            { question: "Q21. 함수 \\(y = \\log_3(x-5) + 6\\)의 역함수 \\(y = a^{x-b} + c\\)일 때,<br>\\(abc\\)의 값을 구하시오.<br><br>① \\(60\\)<br><br>② \\(70\\)<br><br>③ \\(80\\)<br><br>④ \\(90\\)<br><br>⑤ \\(100\\)", answer: "", hint: "", explanation: "" },
            { question: "Q22. 곡선 \\(y = 2^x - 1\\)위의 점 \\(A(3, 7)\\)을 지나고 기울기가 \\(-1\\)인 직선이<br>곡선 \\(y = \\log_2(x+1)\\)과 만나는 점을 \\(B\\)라 하자. 두 점 \\(A\\), \\(B\\)에서<br>\\(x\\)축에 내린 수선의 발을 각각 \\(C\\), \\(D\\)라 할 때, 사각형 \\(ACDB\\)의 넓이는?<br><br><img src='images/part4_q22_graph.png' alt='두 곡선과 사각형' style='max-width: 400px; margin: 10px 0;'>", answer: "", hint: "", explanation: "" },
            { question: "Q23. 함수 \\(y = \\log_a x + b\\)의 그래프가 그 역함수의 그래프가 두 점에서<br>만나고, 두 교점의 \\(x\\)좌표가 \\(1\\), \\(4\\)일 때, \\(ab\\)의 값은?<br>(단, \\(a > 0\\), \\(a \\neq 1\\))<br><br>① \\(2^{\\frac{1}{3}}\\)<br><br>② \\(2^{\\frac{2}{3}}\\)<br><br>③ \\(2\\)<br><br>④ \\(2^{\\frac{4}{3}}\\)<br><br>⑤ \\(2^{\\frac{5}{3}}\\)", answer: "", hint: "", explanation: "" }
          ]},
          { id: 3, name: "Part3. 지수함수의 활용", questions: [
            { question: "Q1. 지수방정식 \\(\\frac{16^x}{2} = 2^{x+11}\\)의 해를 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q2. 다음은 방정식 \\(x^x \\cdot x^6 = (x^x)^4\\)의 근을 찾는 과정에서<br>나는 학생과 선생님의 대화이다. 선생님의 말을 참고해서 학생의<br>대화에서 틀린 점을 찾아서 설명하시오. (단, \\(x > 0\\))<br><br>다은 : 일단 지수법칙을 이용하여 식을 간단히 할래요!<br>선생님 : 네! 계속 해보세요~~<br>다은 : 그럼 \\(x^{x+6} = x^{4x}\\)이고, 지수끼리 같아야 하니까<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\\(x+6 = 4x\\)를 풀면 \\(x = 2\\)가 나오니까 답은 \\(2\\)에요!!<br>선생님 : 음.. 그건 맞는데 다은이가 근을 하나 놓친 것 같은데??", answer: "", hint: "", explanation: "" },
            { question: "Q3. 방정식 \\(2^x + 2^{4-x} = 17\\)의 모든 실근의 합은?<br><br>① \\(2\\)<br><br>② \\(3\\)<br><br>③ \\(4\\)<br><br>④ \\(5\\)<br><br>⑤ \\(6\\)", answer: "", hint: "", explanation: "" },
            { question: "Q4. 지수부등식 \\(\\left(\\frac{1}{27}\\right)^x \\geq \\left(\\frac{1}{9}\\right)^{x-4}\\)의 해를 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q5. 부등식 \\(x^{5x} > x^{3x+10}\\)의 해를 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q6. 부등식 \\(4^x + 2^{x+3} - 20 \\geq 0\\)의 해를 구하시오.", answer: "", hint: "", explanation: "" }
          ]},
          { id: 4, name: "Part4. 로그함수의 활용", questions: [
            { question: "Q1. 방정식 \\(\\log_2 x + \\log_2(x-7) = 3\\)의 해를 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q2. 방정식 \\((\\log_3 9x)^2 - 4\\log_3 9x^2 = 0\\)의 두 근의 곱은?", answer: "", hint: "", explanation: "" },
            { question: "Q3. 방정식 \\(x^{\\log_2 x} = \\frac{4}{x}\\)의 모든 근의 합은?<br><br>① \\(2\\)<br><br>② \\(\\frac{9}{4}\\)<br><br>③ \\(\\frac{5}{2}\\)<br><br>④ \\(\\frac{11}{4}\\)<br><br>⑤ \\(3\\)", answer: "", hint: "", explanation: "" },
            { question: "Q4. 부등식 \\(\\log_3(x-1) < 2\\)의 해를 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q5. 부등식 \\(\\log_3(\\log_2 x) \\leq 1\\)을 만족하는 자연수 \\(x\\)의 최솟값을 \\(m\\), 최댓값을 \\(M\\)이라 할 때, \\(Mm\\)의 값은?", answer: "", hint: "", explanation: "" },
            { question: "Q6. 부등식 \\(\\log_{\\frac{1}{2}} 16x \\cdot \\log_2 \\frac{x}{4} \\geq 0\\)의 해가 \\(a \\leq x \\leq b\\)일 때, \\(ab\\)의 값은?<br><br>① \\(\\frac{1}{2}\\)<br><br>② \\(\\frac{1}{4}\\)<br><br>③ \\(\\frac{1}{8}\\)<br><br>④ \\(\\frac{1}{16}\\)<br><br>⑤ \\(\\frac{1}{32}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q7. 부등식 \\(x^{\\log_{\\frac{1}{3}} x} \\geq 27x^{-1}\\)의 해가 \\(a \\leq x \\leq b\\)일 때, \\(27(a+b)\\)의 값은?", answer: "", hint: "", explanation: "" }
          ]}
        ]
      },
      {
        id: 3,
        name: "Chapter 3. 육십분법과 호도법",
        chapterInfo: [
          { partName: "Part1", description: "일반각", range: "Q1~Q6" },
          { partName: "Part2", description: "육십분법과 호도법", range: "Q1~Q7" }
        ],
        chapters: [
          { id: 1, name: "Part1. 일반각", questions: [
            { question: "Q1. 일반각 = \\(360^\\circ \\times n + a^\\circ\\)과 같이 나타낼 수 있다.<br>이 때 \\(n\\)과 \\(a\\)의 의미를 간단하게 설명해보시오.", answer: "", hint: "", explanation: "" },
            { question: "Q2. 다음 각의 동경이 나타내는 일반각을 \\(360^\\circ \\times n + a^\\circ\\)의 꼴로<br>나타내시오 (단, \\(n\\)은 정수, \\(0^\\circ \\leq a < 360^\\circ\\))<br><br>(1) \\(730^\\circ\\)<br><br>(2) \\(-1070^\\circ\\)", answer: "", hint: "", explanation: "" },
            { question: "Q3. 다음 각은 제 몇 사분면의 각인지 구하시오.<br><br>(1) \\(1200^\\circ\\)<br><br>(2) \\(-160^\\circ\\)<br><br>(3) \\(270^\\circ\\)", answer: "", hint: "", explanation: "" },
            { question: "Q4. \\(\\alpha\\)가 제 \\(2\\)사분면의 각일 때, \\(\\frac{\\alpha}{3}\\)을 나타내는 동경이<br>존재하는 사분면을 모두 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q5. 각 \\(\\theta\\)를 나타내는 동경과 각 \\(7\\theta\\)를 나타내는 동경이<br>일치할 때, 각 \\(\\theta\\)의 크기를 모두 구하시오.<br>(단, \\(0^\\circ < \\theta < 180^\\circ\\))", answer: "", hint: "", explanation: "" },
            { question: "Q6. 두 각 \\(\\theta\\)와 \\(4\\theta\\)의 동경이 \\(x\\)축에 대하여 대칭일 때,<br>모든 \\(\\theta\\)의 크기의 합은? (단, \\(90^\\circ < \\theta < 270^\\circ\\))", answer: "", hint: "", explanation: "" }
          ]},
          { id: 2, name: "Part2. 육십분법과 호도법", questions: [
            { question: "Q1. 1라디안의 의미에 대해 설명하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q2. 호도법의 중요한 의의에 대해 간단히 설명하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q3. 다음 중 옳지 않은 것은?<br><br>① \\(30^\\circ = \\frac{\\pi}{6}\\)<br><br>② \\(\\frac{7}{6}\\pi = 210^\\circ\\)<br><br>③ \\(-\\frac{3}{4}\\pi = -135^\\circ\\)<br><br>④ \\(180^\\circ = \\pi\\)<br><br>⑤ \\(210^\\circ = \\frac{4}{3}\\pi\\)", answer: "", hint: "", explanation: "" },
            { question: "Q4. 다음 각의 동경이 나타내는 일반각을 \\(2n\\pi + \\theta\\)의 꼴로 나타내시오.<br>(단, \\(n\\)은 정수이고, \\(0 \\leq \\theta < 2\\pi\\))<br><br>(1) \\(15\\pi\\)<br><br>(2) \\(-\\frac{7}{3}\\pi\\)<br><br>(3) \\(\\frac{19}{5}\\pi\\)", answer: "", hint: "", explanation: "" },
            { question: "Q5. 반지름의 길이가 \\(r\\), 중심각의 크기가 \\(\\theta\\)인 부채꼴이 있을 때,<br>다음 물음에 답하시오<br><br><img src='images/image6.png' alt='부채꼴' style='max-width: 400px; margin: 10px 0;'><br><br>(1) 부채꼴의 호의 길이를 \\(l\\)이라 할 때,<br>\\(l\\)을 \\(r\\)과 \\(\\theta\\)에 관한 식으로 표현하시오.<br><br>(2) 부채꼴의 넓이를 \\(S\\)라 할 때,<br>\\(S\\)를 \\(r\\)과 \\(\\theta\\)에 관한 식으로 표현하시오.<br><br>(3) 부채꼴의 넓이를 \\(S\\)라 할 때,<br>\\(S\\)를 \\(r\\)과 \\(l\\)에 관한 식으로 표현하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q6. 반지름의 길이가 \\(12\\), 중심각의 크기가 \\(\\frac{\\pi}{4}\\)인<br>부채꼴의 호의 길이와 넓이를 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q7. 중심각의 크기가 \\(1\\) 라디안이고 넓이가 \\(72\\)인<br>부채꼴의 둘레의 길이를 구하시오.", answer: "", hint: "", explanation: "" }
          ]}
        ]
      },
      {
        id: 4,
        name: "Chapter 4. 삼각함수 정의 및 그래프",
        chapterInfo: [
          { partName: "Part1", description: "삼각함수의 정의", range: "Q1~Q14" }
        ],
        chapters: [
          { id: 1, name: "Part1. 삼각함수의 정의", questions: [
            { question: "Q1. 아래 그림을 보고 다음 물음에 답하시오.<br><br><img src='images/image7.png' alt='직각삼각형' style='max-width: 400px; margin: 10px 0;'><br><br>(1) \\(\\sin C\\)를 구하시오.<br><br>(2) \\(\\cos C\\)를 구하시오.<br><br>(3) \\(\\tan A\\)를 구하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q2. 다음 물음에 답하시오.<br><br>(1) \\(\\sin 30^\\circ\\)<br><br>(2) \\(\\cos 45^\\circ\\)<br><br>(3) \\(\\tan 60^\\circ\\)", answer: "", hint: "", explanation: "" },
            { question: "Q3. 다음 그림에서 \\(\\triangle ABC\\)와 \\(\\triangle AB'C'\\)는 서로 닮음이다.<br>옳은 설명을 한 학생을 모두 고르시오.<br>(틀린 학생이 있다면 이유를 적어주셔야 합니다!)<br><br><img src='images/image8.png' alt='닮은 삼각형' style='max-width: 400px; margin: 10px 0;'><br><br>기탄 : 각 \\(B'\\)는 \\(90\\)도야!<br><br>미래 : \\(\\tan A\\)는 \\(\\frac{4}{3}\\)야!<br><br>준희 : \\(\\cos C'\\)는 \\(\\frac{3}{5}\\)야!<br><br>윤후 : \\(\\sin C'\\)는 \\(\\frac{4}{5}\\)야!<br><br>규현 : \\(\\tan C\\)와 \\(\\tan C'\\)의 값은 같아 !", answer: "", hint: "", explanation: "" },
            { question: "Q4. 삼각함수에서 사인함수와 코사인함수 탄젠트함수의<br>정의를 각각 설명하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q5. 원점 \\(O\\)와 점 \\(P(4, -3)\\)을 지나는 동경 \\(OP\\)가 나타내는<br>각의 크기를 \\(\\theta\\)라 할 때, 다음의 값을 구하시오.<br><br>(1) \\(\\sin\\theta\\)<br><br>(2) \\(\\cos\\theta\\)<br><br>(3) \\(\\tan\\theta\\)", answer: "", hint: "", explanation: "" },
            { question: "Q6. 다음 물음에 답하시오.<br><br>(1) 단위원이 무엇인지 설명하시오.<br><br>(2) \\(\\sin\\theta\\)는 단위원 위의 \\((x\\)좌표, \\(y\\)좌표\\()\\)인 점들의 집합이다.<br><br>(3) \\(\\cos\\theta\\)는 단위원 위의 \\((x\\)좌표, \\(y\\)좌표\\()\\)인 점들의 집합이다.<br><br>(4) \\(\\tan\\theta\\)는 직선의 어떤 요소와 연관이 있는지 설명하시오. (답 : 세글자)", answer: "", hint: "", explanation: "" },
            { question: "Q7. 다음 삼각함수의 값을 구하시오.<br><br>(1) \\(\\cos 150^\\circ\\)<br><br>(2) \\(\\sin\\left(-\\frac{\\pi}{4}\\right)\\)<br><br>(3) \\(\\tan\\frac{4}{3}\\pi\\)", answer: "", hint: "", explanation: "" },
            { question: "Q8. \\(\\sin\\theta > 0\\)을 만족하는 각 \\(\\theta\\)는 제 몇 사분면의<br>각인지 말하고, 그 이유를 간략하게 설명하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q9. 다음 조건을 만족하는 각 \\(\\theta\\)는 제 몇 사분면의<br>각인지 말하시오.<br><br>\\(\\sin\\theta \\times \\tan\\theta < 0\\), \\(\\sin\\theta \\times \\cos\\theta > 0\\)", answer: "", hint: "", explanation: "" },
            { question: "Q10. \\(\\frac{\\pi}{2} < \\theta < \\pi\\)일 때, \\(\\sqrt{\\sin^2\\theta} - \\sqrt{(\\cos\\theta - \\sin\\theta)^2}\\)를 간단히 하면?<br><br>① \\(\\sin\\theta\\)<br><br>② \\(\\cos\\theta\\)<br><br>③ \\(-\\sin\\theta\\)<br><br>④ \\(-\\cos\\theta\\)<br><br>⑤ \\(2\\sin\\theta - \\cos\\theta\\)", answer: "", hint: "", explanation: "" },
            { question: "Q11. 삼각함수의 상호 관계에서 \\(\\sin^2\\theta + \\cos^2\\theta = 1\\)이라는<br>관계식이 성립하는 이유를 간단히 설명하시오.", answer: "", hint: "", explanation: "" },
            { question: "Q12. \\(\\sin\\theta = -\\frac{2\\sqrt{2}}{3}\\)일 때, \\(\\cos\\theta + \\tan\\theta\\)의 값은? (단, \\(\\pi < \\theta < \\frac{3}{2}\\pi\\))<br><br>① \\(\\frac{6\\sqrt{2} - 1}{3}\\)<br><br>② \\(\\frac{6\\sqrt{2} - 2}{3}\\)<br><br>③ \\(\\frac{6\\sqrt{3} - 1}{3}\\)<br><br>④ \\(\\frac{6\\sqrt{3} - 2}{3}\\)<br><br>⑤ \\(\\frac{6\\sqrt{3} - 4}{3}\\)", answer: "", hint: "", explanation: "" },
            { question: "Q13. \\(\\theta\\)가 제 \\(1\\)사분면의 각이고 \\(\\sin\\theta - \\cos\\theta = \\frac{\\sqrt{2}}{2}\\)일 때,<br>다음 식의 값을 구하시오.<br><br>(1) \\(\\sin\\theta \\cos\\theta\\)<br><br>(2) \\(\\sin\\theta + \\cos\\theta\\)", answer: "", hint: "", explanation: "" },
            { question: "Q14. 이차방정식 \\(4x^2 - kx + 1 = 0\\)의 두 근이 \\(\\sin\\theta\\), \\(\\cos\\theta\\)일 때,<br>양수 \\(k\\)의 값은?<br><br>① \\(\\sqrt{6}\\)<br><br>② \\(2\\sqrt{6}\\)<br><br>③ \\(3\\sqrt{6}\\)<br><br>④ \\(4\\sqrt{6}\\)<br><br>⑤ \\(5\\sqrt{6}\\)", answer: "", hint: "", explanation: "" }
          ]}
        ]
      },
      { id: 5, name: "Chapter 5. 사인법칙과 코사인법칙", chapters: [] },
      { id: 6, name: "Chapter 6. 등차수열과 등비수열", chapters: [] },
      {
        id: 7,
        name: "Chapter 7. 수열의 합",
        chapters: []
      },
      {
        id: 8,
        name: "Chapter 8. 수학적 귀납법",
        chapters: []
      }
    ];

    // 상태 관리
    const state = {
      userType: null, // 'student' or 'admin'
      studentName: '',
      phone: '',
      teacherName: '', // 학생의 담당 선생님
      adminName: '', // 관리자 이름
      isLoggedIn: false,
      uid: '',
      loading: false,
      selectedCategory: null,
      currentTheme: null,
      currentQuestion: 0,
      answers: {},
      allStudentData: {},
      showResults: false,
      lockTimers: {},
      currentTime: Date.now(),
      autoLogin: false,
      // 관리자 전용
      adminStudents: [], // 관리자가 담당하는 학생 목록
      selectedStudent: null, // 관리자가 선택한 학생
      showAdminRegister: false,
      studentStatusFilter: 'active', // 'active' (재원생) 또는 'withdrawn' (퇴원생)
      // 학습 기록 전용
      recordSelectedCategory: null, // 학습 기록에서 선택한 카테고리
      // 선생님 메모
      teacherNotes: {}, // { themeId: { questionIndex: "메모 내용" } }
      // 타이머
      questionTimer: 180, // 초 단위 (3분 = 180초)
      timerInterval: null,
      timerExpired: false
    };

    // 자동 로그인 체크
    function checkAutoLogin() {
      // 학생 자동 로그인 체크
      const savedName = localStorage.getItem('ox_quiz_student_name');
      const savedPhone = localStorage.getItem('ox_quiz_student_phone');
      const savedTeacher = localStorage.getItem('ox_quiz_teacher_name');
      const studentAutoLoginEnabled = localStorage.getItem('ox_quiz_auto_login') === 'true';

      if (studentAutoLoginEnabled && savedName && savedPhone) {
        console.log('학생 자동 로그인 시도:', savedName);
        state.studentName = savedName;
        state.phone = savedPhone;
        state.teacherName = savedTeacher || '';
        state.autoLogin = true;
        state.userType = 'student';
        return { type: 'student' };
      }

      // 관리자 자동 로그인 체크
      const savedAdminName = localStorage.getItem('ox_quiz_admin_name');
      const adminAutoLoginEnabled = localStorage.getItem('ox_quiz_admin_auto_login') === 'true';

      if (adminAutoLoginEnabled && savedAdminName) {
        console.log('관리자 자동 로그인 시도:', savedAdminName);
        state.adminName = savedAdminName;
        state.autoLogin = true;
        state.userType = 'admin';
        return { type: 'admin', name: savedAdminName };
      }

      return null;
    }

    // 로그인 정보 저장
    function saveLoginInfo(name, phone, teacher, autoLogin) {
      localStorage.setItem('ox_quiz_student_name', name);
      localStorage.setItem('ox_quiz_student_phone', phone);
      localStorage.setItem('ox_quiz_teacher_name', teacher);
      localStorage.setItem('ox_quiz_auto_login', autoLogin ? 'true' : 'false');
    }

    // 로그아웃
    function logout() {
      localStorage.removeItem('ox_quiz_student_name');
      localStorage.removeItem('ox_quiz_student_phone');
      localStorage.removeItem('ox_quiz_teacher_name');
      localStorage.removeItem('ox_quiz_auto_login');
      localStorage.removeItem('ox_quiz_admin_name');
      localStorage.removeItem('ox_quiz_admin_auto_login');
      state.isLoggedIn = false;
      state.userType = null;
      state.studentName = '';
      state.phone = '';
      state.teacherName = '';
      state.adminName = '';
      state.uid = '';
      state.selectedCategory = null;
      state.currentTheme = null;
      state.autoLogin = false;
      state.adminStudents = [];
      state.selectedStudent = null;
      render();
    }

    // Firebase 함수
    async function loadData(id) {
      try {
        const doc = await db.collection('students').doc(id).get();
        if (doc.exists) {
          const studentData = doc.data();
          state.allStudentData[state.studentName] = studentData;
          state.lockTimers = studentData.lockTimers || {};
          // 기존 데이터에서 teacherName 가져오기
          if (!state.teacherName && studentData.teacherName) {
            state.teacherName = studentData.teacherName;
          }
        } else {
          state.allStudentData[state.studentName] = { 
            attempts: [],
            lockTimers: {},
            teacherName: state.teacherName,
            studentName: state.studentName,
            phone: state.phone,
            status: 'active' // 신규 학생은 재원생으로 시작
          };
          state.lockTimers = {};
        }
        console.log('데이터 로드 완료:', state.allStudentData[state.studentName]);
      } catch (error) {
        console.error('데이터 로드 오류:', error);
        state.allStudentData[state.studentName] = { 
          attempts: [],
          lockTimers: {},
          teacherName: state.teacherName,
          studentName: state.studentName,
          phone: state.phone,
          status: 'active'
        };
        state.lockTimers = {};
      }
    }

    async function saveData(newData) {
      try {
        if (navigator.onLine) {
          await db.collection('students').doc(state.uid).set(newData);
          console.log('온라인 저장 완료');
        } else {
          await saveToIndexedDB(newData);
          console.log('오프라인 임시 저장 완료');
          alert('오프라인 상태입니다. 온라인 복구 시 자동으로 동기화됩니다.');
        }
      } catch (error) {
        console.error('데이터 저장 오류:', error);
        await saveToIndexedDB(newData);
        alert('데이터를 로컬에 임시 저장했습니다.');
      }
    }

    // 관리자 함수
    async function loadAdminStudents(teacherName) {
      try {
        const snapshot = await db.collection('students')
          .where('teacherName', '==', teacherName)
          .get();
        
        const students = [];
        snapshot.forEach(doc => {
          students.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        state.adminStudents = students;
        console.log('학생 목록 로드 완료:', students.length, '명');
      } catch (error) {
        console.error('학생 목록 로드 오류:', error);
        state.adminStudents = [];
      }
    }

    async function registerAdmin(adminName, secretKey) {
      if (secretKey !== ADMIN_SECRET_KEY) {
        alert('보안 키가 올바르지 않습니다.');
        return false;
      }

      try {
        const adminId = `admin_${adminName}`;
        // students 컬렉션에 관리자 정보 저장 (isAdmin: true 플래그 추가)
        await db.collection('students').doc(adminId).set({
          name: adminName,
          isAdmin: true,
          registeredAt: new Date().toISOString()
        });
        
        alert('관리자 등록이 완료되었습니다!');
        return true;
      } catch (error) {
        console.error('관리자 등록 오류:', error);
        alert('관리자 등록 중 오류가 발생했습니다: ' + error.message);
        return false;
      }
    }

    async function checkAdminExists(adminName) {
      try {
        const adminId = `admin_${adminName}`;
        const doc = await db.collection('students').doc(adminId).get();
        return doc.exists && doc.data()?.isAdmin === true;
      } catch (error) {
        console.error('관리자 확인 오류:', error);
        return false;
      }
    }

    // 유틸리티 함수
    function getThemeStatus(categoryId, themeId) {
      const attempts = state.allStudentData[state.studentName]?.attempts || [];
      const themeAttempts = attempts.filter(a => a.categoryId === categoryId && a.themeId === themeId);
      
      if (themeAttempts.length === 0) return { status: 'new', lastAttempt: null, attemptCount: 0 };
      
      const lastAttempt = themeAttempts[themeAttempts.length - 1];
      const percentage = lastAttempt.percentage;
      
      return { 
        status: percentage === 100 ? 'completed' : 'retry', 
        lastAttempt, 
        attemptCount: themeAttempts.length
      };
    }

    function isLocked(categoryId, themeId) {
      const lockUntil = state.lockTimers[`${state.studentName}-${categoryId}-${themeId}`];
      if (!lockUntil) return false;
      return state.currentTime < lockUntil;
    }

    function getRemainingTime(categoryId, themeId) {
      const lockUntil = state.lockTimers[`${state.studentName}-${categoryId}-${themeId}`];
      if (!lockUntil) return 0;
      const remaining = Math.max(0, Math.ceil((lockUntil - state.currentTime) / 1000));
      return remaining;
    }

    // 이벤트 핸들러
    async function handleStudentLogin(autoLoginChecked = false, isNewStudent = false) {
      if (state.studentName.trim() && state.phone.trim()) {
        const p = state.phone.replace(/[^0-9]/g, '');
        if (p.length < 10 || p.length > 11) {
          alert('올바른 전화번호를 입력해주세요. (10-11자리)');
          return;
        }

        if (isNewStudent && !state.teacherName.trim()) {
          alert('담당 선생님 성함을 입력해주세요.');
          return;
        }

        state.loading = true;
        render();
        const id = `${state.studentName.trim()}_${p}`;
        state.uid = id;
        
        saveLoginInfo(state.studentName.trim(), p, state.teacherName.trim(), autoLoginChecked);
        
        await loadData(id);
        
        // 퇴원생 체크
        const studentData = state.allStudentData[state.studentName];
        if (studentData && studentData.status === 'withdrawn') {
          state.loading = false;
          alert('퇴원 처리된 학생은 로그인할 수 없습니다.\\n담당 선생님께 문의해주세요.');
          logout();
          return;
        }
        
        // 신규 학생인 경우 선생님 정보 저장
        if (isNewStudent) {
          const newData = {
            ...state.allStudentData[state.studentName],
            teacherName: state.teacherName.trim(),
            studentName: state.studentName.trim(),
            phone: p,
            status: 'active'
          };
          await saveData(newData);
        }
        
        state.isLoggedIn = true;
        state.userType = 'student';
        state.loading = false;
        render();
      }
    }

    async function handleAdminLogin() {
      if (!state.adminName.trim()) {
        alert('관리자 이름을 입력해주세요.');
        return;
      }

      const adminPassword = document.getElementById('adminPasswordInput')?.value;
      if (!adminPassword) {
        alert('비밀번호를 입력해주세요.');
        return;
      }

      if (adminPassword !== ADMIN_PASSWORD) {
        alert('비밀번호가 올바르지 않습니다.');
        return;
      }

      // 자동 로그인 체크박스 확인 (render 전에 먼저 확인)
      const autoLoginChecked = document.getElementById('adminAutoLoginCheckbox')?.checked || false;
      console.log('관리자 자동 로그인 체크:', autoLoginChecked);

      state.loading = true;
      render();

      const exists = await checkAdminExists(state.adminName.trim());
      
      if (!exists) {
        state.loading = false;
        alert('등록되지 않은 관리자입니다. 먼저 관리자 등록을 진행해주세요.');
        render();
        return;
      }

      // 자동 로그인 정보 저장
      if (autoLoginChecked) {
        console.log('관리자 자동 로그인 정보 저장:', state.adminName.trim());
        localStorage.setItem('ox_quiz_admin_name', state.adminName.trim());
        localStorage.setItem('ox_quiz_admin_auto_login', 'true');
      }

      await loadAdminStudents(state.adminName.trim());
      
      state.isLoggedIn = true;
      state.userType = 'admin';
      state.loading = false;
      render();
    }

    function handleStartQuiz(themeId) {
      if (isLocked(state.selectedCategory, themeId)) return;

      state.currentTheme = themeId;
      state.currentQuestion = 0;
      state.answers = {};
      startQuestionTimer();
      render();
    }

    // 타이머 함수들
    function startQuestionTimer() {
      // 기존 타이머가 있으면 정리
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
      }

      // 타이머 초기화 (3분 = 180초)
      state.questionTimer = 180;
      state.timerExpired = false;

      // 1초마다 업데이트
      state.timerInterval = setInterval(() => {
        if (state.questionTimer > 0) {
          state.questionTimer--;
          updateTimerDisplay();
        } else {
          state.timerExpired = true;
          clearInterval(state.timerInterval);
          updateTimerDisplay();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const timerElement = document.getElementById('questionTimer');
      if (timerElement) {
        const minutes = Math.floor(state.questionTimer / 60);
        const seconds = state.questionTimer % 60;
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (state.timerExpired) {
          timerElement.innerHTML = `<span class="text-red-400 font-bold">⏰ 시간 종료</span>`;
        } else if (state.questionTimer <= 30) {
          timerElement.innerHTML = `<span class="text-red-400 font-bold">⏱ ${timeString}</span>`;
        } else {
          timerElement.innerHTML = `<span class="text-gray-300">⏱ ${timeString}</span>`;
        }
      }
    }

    function stopQuestionTimer() {
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
      }
    }

    function handleAnswer(selectedAnswer) {
      const key = state.currentQuestion;
      if (state.answers[key]) return;

      const category = categories.find(c => c.id === state.selectedCategory);
      const theme = category.chapters.find(t => t.id === state.currentTheme);
      const question = theme.questions[state.currentQuestion];

      // 서술형 문제 (answer가 빈 문자열)의 경우 O를 선택하면 맞은 것으로 처리
      const isCorrect = question.answer === ""
        ? selectedAnswer === "O"
        : selectedAnswer === question.answer;

      const status = getThemeStatus(state.selectedCategory, state.currentTheme);
      const isRetake = status.attemptCount >= 1;

      state.answers[key] = { selected: selectedAnswer, correct: isCorrect, isRetake };
      render();
    }

    function handleNext() {
      const category = categories.find(c => c.id === state.selectedCategory);
      const theme = category.chapters.find(t => t.id === state.currentTheme);
      if (state.currentQuestion < theme.questions.length - 1) {
        state.currentQuestion++;
        startQuestionTimer();
        render();
      }
    }

    function handlePrev() {
      if (state.currentQuestion > 0) {
        state.currentQuestion--;
        startQuestionTimer();
        render();
      }
    }

    async function handleFinishQuiz() {
      stopQuestionTimer();
      const category = categories.find(c => c.id === state.selectedCategory);
      const theme = category.chapters.find(t => t.id === state.currentTheme);
      const correct = Object.values(state.answers).filter(a => a.correct).length;
      const total = theme.questions.length;
      const percentage = Math.round((correct / total) * 100);
      
      const wrongQuestions = theme.questions
        .map((q, idx) => ({ ...q, index: idx }))
        .filter(q => state.answers[q.index] && !state.answers[q.index].correct)
        .map(q => q.question);

      const attemptData = {
        categoryId: state.selectedCategory,
        categoryName: category.name,
        themeId: state.currentTheme,
        themeName: theme.name,
        date: new Date().toLocaleString('ko-KR'),
        correct,
        total,
        percentage,
        wrongQuestions,
        answers: { ...state.answers }
      };

      const newData = {
        ...state.allStudentData[state.studentName],
        attempts: [...(state.allStudentData[state.studentName]?.attempts || []), attemptData],
        teacherName: state.teacherName, // teacherName 항상 포함
        studentName: state.studentName,
        phone: state.phone
      };

      if (percentage < 100) {
        const lockUntil = Date.now() + 60000;
        state.lockTimers[`${state.studentName}-${state.selectedCategory}-${state.currentTheme}`] = lockUntil;
        newData.lockTimers = state.lockTimers;
      }

      state.allStudentData[state.studentName] = newData;
      await saveData(newData);

      state.currentTheme = null;
      state.currentQuestion = 0;
      state.answers = {};
      render();
    }

    // 렌더링 함수
    let isRendering = false;
    function render() {
      if (isRendering) return;
      isRendering = true;
      
      const app = document.getElementById('app');

      if (state.loading) {
        app.innerHTML = `
          <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
              <div class="w-16 h-16 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p class="text-white font-bold">데이터 불러오는 중...</p>
            </div>
          </div>
        `;
        isRendering = false;
        return;
      }

      if (!state.isLoggedIn) {
        if (state.showAdminRegister) {
          renderAdminRegister(app);
        } else {
          renderLogin(app);
        }
        // 로그인 화면은 수식이 없으므로 즉시 표시
        if (!app.classList.contains('ready')) {
          app.classList.add('ready');
        }
        isRendering = false;
        return;
      }

      if (state.userType === 'admin') {
        renderAdminScreen(app);
      } else {
        renderMainScreen();
      }
      
      isRendering = false;
      
      // DOM 업데이트 후 KaTeX 렌더링 (디바운싱 적용됨)
      renderMath();
    }

    // KaTeX 렌더링 함수 (강력한 디바운싱)
    let renderMathTimeout = null;
    let isRenderingMath = false;
    let lastRenderTime = 0;
    let isFirstRender = true;
    
    function renderMath() {
      // KaTeX auto-render 실행
      if (typeof renderMathInElement !== 'undefined') {
        const app = document.getElementById('app');
        if (app) {
          try {
            renderMathInElement(app, {
              delimiters: [
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
              ],
              throwOnError: false
            });
            console.log('✓ KaTeX 렌더링 완료');
          } catch (error) {
            console.error('KaTeX 렌더링 오류:', error);
          }
        }
      }

      // 첫 렌더링 시 앱 즉시 표시
      if (isFirstRender) {
        const app = document.getElementById('app');
        if (app && !app.classList.contains('ready')) {
          app.classList.add('ready');
          console.log('✓ 앱 표시');
        }
        isFirstRender = false;
      }
    }

    function renderLogin(app) {
      app.innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="max-w-md w-full">
            <div class="bg-gray-900 rounded-2xl p-8 shadow-2xl border border-orange-500/30">
              <div class="flex justify-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/50">
                  ${icon('bookOpen', 'text-white', 32)}
                </div>
              </div>
              <h1 class="text-3xl font-bold text-center mb-2 text-white">구두테스트 퀴즈</h1>
              <h2 class="text-xl text-center mb-8 text-orange-500">대수</h2>
              
              <div class="flex gap-2 mb-6">
                <button id="studentBtn" class="flex-1 py-2 px-4 bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg font-bold text-white text-sm">
                  학생
                </button>
                <button id="adminBtn" class="flex-1 py-2 px-4 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white text-sm transition-all">
                  관리자
                </button>
              </div>

              <div id="loginForm"></div>
            </div>
          </div>
        </div>
      `;

      const studentBtn = document.getElementById('studentBtn');
      const adminBtn = document.getElementById('adminBtn');
      const loginForm = document.getElementById('loginForm');

      function showStudentForm() {
        studentBtn.className = "flex-1 py-2 px-4 bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg font-bold text-white text-sm";
        adminBtn.className = "flex-1 py-2 px-4 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white text-sm transition-all";
        
        loginForm.innerHTML = `
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-300">학생 이름</label>
              <input
                type="text"
                id="nameInput"
                value="${state.studentName}"
                placeholder="이름을 입력하세요"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-300">전화번호</label>
              <input
                type="tel"
                id="phoneInput"
                value="${state.phone}"
                placeholder="전화번호 (- 없이)"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
              />
              <p class="text-xs text-gray-500 mt-1">예: 01012345678</p>
            </div>

            <div id="teacherField" style="display: none;">
              <label class="block text-sm font-semibold mb-2 text-gray-300">담당 선생님 성함</label>
              <input
                type="text"
                id="teacherInput"
                value="${state.teacherName}"
                placeholder="선생님 성함"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
              />
              <p class="text-xs text-gray-500 mt-1">처음 가입시에만 입력</p>
            </div>

            <div class="flex items-center gap-2">
              <input
                type="checkbox"
                id="newStudentCheck"
                class="w-4 h-4 bg-gray-800 border-gray-700 rounded focus:ring-orange-500 focus:ring-2 text-orange-500"
              />
              <label for="newStudentCheck" class="text-sm text-gray-300 cursor-pointer">처음 가입하는 학생입니다</label>
            </div>

            <div>
              <label class="flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="autoLoginCheck"
                  ${state.autoLogin ? 'checked' : ''}
                  class="w-4 h-4 bg-gray-800 border-gray-700 rounded focus:ring-orange-500 focus:ring-2 text-orange-500"
                />
                <span class="ml-2 text-sm text-gray-300">자동 로그인</span>
              </label>
              <p class="text-xs text-gray-500 mt-1 ml-6">다음부터 자동으로 로그인됩니다</p>
            </div>
            
            <button
              id="loginBtn"
              class="w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95"
            >
              시작하기
            </button>
          </div>
        `;

        const nameInput = document.getElementById('nameInput');
        const phoneInput = document.getElementById('phoneInput');
        const teacherInput = document.getElementById('teacherInput');
        const newStudentCheck = document.getElementById('newStudentCheck');
        const teacherField = document.getElementById('teacherField');
        const loginBtn = document.getElementById('loginBtn');

        nameInput.addEventListener('input', (e) => {
          state.studentName = e.target.value;
        });
        
        phoneInput.addEventListener('input', (e) => {
          state.phone = e.target.value;
        });

        teacherInput.addEventListener('input', (e) => {
          state.teacherName = e.target.value;
        });

        newStudentCheck.addEventListener('change', (e) => {
          teacherField.style.display = e.target.checked ? 'block' : 'none';
        });

        phoneInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const autoLoginChecked = document.getElementById('autoLoginCheck').checked;
            const isNewStudent = newStudentCheck.checked;
            handleStudentLogin(autoLoginChecked, isNewStudent);
          }
        });

        loginBtn.addEventListener('click', () => {
          const autoLoginChecked = document.getElementById('autoLoginCheck').checked;
          const isNewStudent = newStudentCheck.checked;
          handleStudentLogin(autoLoginChecked, isNewStudent);
        });
      }

      function showAdminForm() {
        studentBtn.className = "flex-1 py-2 px-4 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white text-sm transition-all";
        adminBtn.className = "flex-1 py-2 px-4 bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg font-bold text-white text-sm";
        
        loginForm.innerHTML = `
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-300">관리자 이름</label>
              <input
                type="text"
                id="adminNameInput"
                value="${state.adminName}"
                placeholder="이름을 입력하세요"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-300">비밀번호</label>
              <input
                type="password"
                id="adminPasswordInput"
                placeholder="비밀번호를 입력하세요"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
              />
            </div>

            <div class="flex items-center">
              <input
                type="checkbox"
                id="adminAutoLoginCheckbox"
                class="w-4 h-4 bg-gray-800 border-gray-700 rounded focus:ring-orange-500 focus:ring-2"
              />
              <label for="adminAutoLoginCheckbox" class="ml-2 text-sm text-gray-300">
                자동 로그인
              </label>
            </div>
            
            <button
              id="adminLoginBtn"
              class="w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95"
            >
              로그인
            </button>

            <button
              id="adminRegisterBtn"
              class="w-full py-3 bg-gray-800 hover:bg-gray-700 rounded-xl font-bold text-white transition-all border border-gray-700"
            >
              관리자 등록
            </button>
          </div>
        `;

        const adminNameInput = document.getElementById('adminNameInput');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminRegisterBtn = document.getElementById('adminRegisterBtn');

        adminNameInput.addEventListener('input', (e) => {
          state.adminName = e.target.value;
        });

        adminPasswordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleAdminLogin();
          }
        });

        adminLoginBtn.addEventListener('click', handleAdminLogin);
        
        adminRegisterBtn.addEventListener('click', () => {
          state.showAdminRegister = true;
          render();
        });
      }

      studentBtn.addEventListener('click', showStudentForm);
      adminBtn.addEventListener('click', showAdminForm);

      showStudentForm();
    }

    function renderAdminRegister(app) {
      app.innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="max-w-md w-full">
            <div class="bg-gray-900 rounded-2xl p-8 shadow-2xl border border-orange-500/30">
              <div class="mb-6">
                <button id="backBtn" class="text-sm text-orange-500 hover:text-orange-400 flex items-center font-semibold">
                  ${icon('chevronLeft', '', 16)}돌아가기
                </button>
              </div>

              <div class="flex justify-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/50">
                  ${icon('settings', 'text-white', 32)}
                </div>
              </div>
              
              <h1 class="text-2xl font-bold text-center mb-2 text-white">관리자 등록</h1>
              <p class="text-sm text-center mb-6 text-gray-400">보안 키가 필요합니다</p>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold mb-2 text-gray-300">관리자 이름</label>
                  <input
                    type="text"
                    id="regAdminNameInput"
                    placeholder="이름을 입력하세요"
                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-2 text-gray-300">보안 키</label>
                  <input
                    type="password"
                    id="secretKeyInput"
                    placeholder="보안 키를 입력하세요"
                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
                  />
                  <p class="text-xs text-red-400 mt-1">⚠️ 관리자만 알고 있는 보안 키</p>
                </div>
                
                <button
                  id="registerBtn"
                  class="w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95"
                >
                  등록하기
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('backBtn').addEventListener('click', () => {
        state.showAdminRegister = false;
        render();
      });

      const regAdminNameInput = document.getElementById('regAdminNameInput');
      const secretKeyInput = document.getElementById('secretKeyInput');
      const registerBtn = document.getElementById('registerBtn');

      registerBtn.addEventListener('click', async () => {
        const name = regAdminNameInput.value.trim();
        const key = secretKeyInput.value.trim();

        if (!name) {
          alert('이름을 입력해주세요.');
          return;
        }

        if (!key) {
          alert('보안 키를 입력해주세요.');
          return;
        }

        const success = await registerAdmin(name, key);
        if (success) {
          state.showAdminRegister = false;
          render();
        }
      });
    }

    function renderAdminScreen(app) {
      if (state.selectedStudent) {
        renderAdminStudentDetail(app);
        return;
      }

      // 재원생/퇴원생 필터링
      const activeStudents = state.adminStudents.filter(s => s.status !== 'withdrawn');
      const withdrawnStudents = state.adminStudents.filter(s => s.status === 'withdrawn');
      const displayStudents = (state.studentStatusFilter === 'withdrawn') ? withdrawnStudents : activeStudents;
      
      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="bg-gray-900 rounded-2xl p-6 mb-8 shadow-xl border border-orange-500/30">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                    ${icon('users', 'text-white')}
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-white">${state.adminName} 선생님</h2>
                    <p class="text-sm text-gray-400 mt-1">담당 학생 관리</p>
                  </div>
                </div>
                <button id="logoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95 text-sm">
                  로그아웃
                </button>
              </div>
            </div>

            <!-- 재원생/퇴원생 탭 -->
            <div class="mb-6">
              <div class="flex gap-2 mb-4">
                <button id="activeTab" class="px-6 py-3 rounded-lg font-bold transition-all ${state.studentStatusFilter !== 'withdrawn' ? 'bg-orange-500 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}">
                  재원생 (${activeStudents.length}명)
                </button>
                <button id="withdrawnTab" class="px-6 py-3 rounded-lg font-bold transition-all ${state.studentStatusFilter === 'withdrawn' ? 'bg-gray-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}">
                  퇴원생 (${withdrawnStudents.length}명)
                </button>
              </div>
              
              <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <div class="flex items-center justify-between">
                  <span class="text-gray-400 text-sm font-semibold">
                    ${state.studentStatusFilter === 'withdrawn' ? '퇴원생' : '재원생'} 수
                  </span>
                  <span class="text-2xl font-bold text-orange-400">${displayStudents.length}명</span>
                </div>
              </div>
            </div>

            ${displayStudents.length === 0 ? `
              <div class="bg-gray-900 rounded-2xl p-12 text-center border border-gray-800">
                ${icon('users', 'mx-auto mb-4 text-gray-600', 48)}
                <p class="text-gray-400 font-medium">
                  ${state.studentStatusFilter === 'withdrawn' ? '퇴원 처리된 학생이 없습니다.' : '아직 담당 학생이 없습니다.'}
                </p>
                ${state.studentStatusFilter !== 'withdrawn' ? `
                  <p class="text-sm text-gray-500 mt-2">학생이 회원가입할 때 선생님 성함을 입력하면 자동으로 연결됩니다.</p>
                ` : ''}
              </div>
            ` : `
              <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${displayStudents.map(student => {
                  const attempts = student.attempts || [];
                  const totalAttempts = attempts.length;
                  const avgPercentage = totalAttempts > 0 
                    ? Math.round(attempts.reduce((sum, a) => sum + a.percentage, 0) / totalAttempts)
                    : 0;
                  const completedThemes = attempts.filter(a => a.percentage === 100).length;

                  return `
                    <button
                      data-student="${student.id}"
                      class="student-btn bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-xl hover:shadow-orange-500/20 hover:border-orange-500/50 transition-all text-left transform hover:scale-105 active:scale-95"
                    >
                      <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                          ${icon('user', 'text-white', 20)}
                        </div>
                        <div>
                          <h3 class="text-base font-bold text-white">${student.studentName || '이름 없음'}</h3>
                          <p class="text-xs text-gray-500">${student.phone || ''}</p>
                        </div>
                      </div>
                      
                      <div class="grid grid-cols-3 gap-2 mb-3">
                        <div class="bg-gray-800/50 rounded-lg p-2 text-center">
                          <div class="text-lg font-bold text-orange-400">${totalAttempts}</div>
                          <div class="text-xs text-gray-500">시도</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-lg p-2 text-center">
                          <div class="text-lg font-bold text-green-400">${completedThemes}</div>
                          <div class="text-xs text-gray-500">완료</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-lg p-2 text-center">
                          <div class="text-lg font-bold text-blue-400">${avgPercentage}%</div>
                          <div class="text-xs text-gray-500">평균</div>
                        </div>
                      </div>

                      <div class="text-xs text-gray-400 text-right">
                        자세히 보기 →
                      </div>
                    </button>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        </div>
      `;

      document.getElementById('logoutBtn').addEventListener('click', () => {
        if (confirm('로그아웃 하시겠습니까?')) {
          logout();
        }
      });

      // 탭 전환 이벤트
      document.getElementById('activeTab').addEventListener('click', () => {
        state.studentStatusFilter = 'active';
        render();
      });

      document.getElementById('withdrawnTab').addEventListener('click', () => {
        state.studentStatusFilter = 'withdrawn';
        render();
      });

      document.querySelectorAll('.student-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const studentId = btn.dataset.student;
          state.selectedStudent = state.adminStudents.find(s => s.id === studentId);
          render();
        });
      });
    }

    function renderAdminStudentDetail(app) {
      const student = state.selectedStudent;
      const attempts = student.attempts || [];

      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="mb-4">
              <button id="backBtn" class="text-sm text-orange-500 hover:text-orange-400 flex items-center font-semibold">
                ${icon('chevronLeft', '', 16)}학생 목록으로 돌아가기
              </button>
            </div>

            <div class="bg-gray-900 rounded-2xl p-6 mb-6 shadow-xl border border-orange-500/30">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                    ${icon('user', 'text-white')}
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-white">${student.studentName || '이름 없음'}</h2>
                    <p class="text-sm text-gray-400 mt-1">${student.phone || ''}</p>
                  </div>
                </div>
                ${student.status === 'withdrawn' ? `
                  <button id="reactivateBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95 text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    재원 처리
                  </button>
                ` : `
                  <button id="withdrawBtn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95 text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"/>
                    </svg>
                    퇴원 처리
                  </button>
                `}
              </div>
              ${student.status === 'withdrawn' ? `
                <div class="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-3 mt-4">
                  <p class="text-yellow-400 text-sm font-bold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    퇴원 처리된 학생입니다
                  </p>
                </div>
              ` : ''}
            </div>

            <div class="grid md:grid-cols-4 gap-4 mb-6">
              <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <div class="text-center">
                  <div class="text-2xl font-bold text-orange-400">${attempts.length}</div>
                  <div class="text-xs text-gray-500 mt-1">전체 시도</div>
                </div>
              </div>
              <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <div class="text-center">
                  <div class="text-2xl font-bold text-green-400">${attempts.filter(a => a.percentage === 100).length}</div>
                  <div class="text-xs text-gray-500 mt-1">완료 테마</div>
                </div>
              </div>
              <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-400">
                    ${attempts.length > 0 ? Math.round(attempts.reduce((sum, a) => sum + a.percentage, 0) / attempts.length) : 0}%
                  </div>
                  <div class="text-xs text-gray-500 mt-1">평균 정답률</div>
                </div>
              </div>
              <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <div class="text-center">
                  <div class="text-2xl font-bold text-purple-400">
                    ${attempts.length > 0 ? Math.round(attempts.reduce((sum, a) => sum + a.correct, 0) / attempts.length) : 0}
                  </div>
                  <div class="text-xs text-gray-500 mt-1">평균 정답 수</div>
                </div>
              </div>
            </div>

            ${attempts.length === 0 ? `
              <div class="bg-gray-900 rounded-2xl p-12 text-center border border-gray-800">
                ${icon('barChart', 'mx-auto mb-4 text-gray-600', 48)}
                <p class="text-gray-400 font-medium">아직 학습 기록이 없습니다.</p>
              </div>
            ` : `
              <div class="space-y-4">
                ${(() => {
                  const themeGroups = {};
                  attempts.forEach(attempt => {
                    const key = `${attempt.categoryName}-${attempt.themeName}`;
                    if (!themeGroups[key]) {
                      themeGroups[key] = [];
                    }
                    themeGroups[key].push(attempt);
                  });

                  return Object.entries(themeGroups).map(([key, themeAttempts]) => {
                    const lastAttempt = themeAttempts[themeAttempts.length - 1];
                    const allWrongQuestions = themeAttempts
                      .flatMap(a => a.wrongQuestions || [])
                      .filter((q, idx, arr) => arr.indexOf(q) === idx);

                    return `
                      <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-xl">
                        <div class="flex justify-between items-start mb-4">
                          <div>
                            <h3 class="text-sm font-bold text-gray-400 mb-1">${lastAttempt.categoryName}</h3>
                            <h4 class="text-base font-bold text-white">${lastAttempt.themeName}</h4>
                            <p class="text-xs text-gray-500 mt-1">최근 시도: ${lastAttempt.date}</p>
                          </div>
                          <div class="text-right">
                            <div class="text-2xl font-bold ${lastAttempt.percentage === 100 ? 'text-green-400' : 'text-orange-400'}">
                              ${lastAttempt.percentage}%
                            </div>
                            <div class="text-xs text-gray-500 font-semibold">${lastAttempt.correct} / ${lastAttempt.total}</div>
                          </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 pt-4 border-t border-gray-800 mb-4">
                          <div class="text-center">
                            <div class="text-lg font-bold text-green-400">${lastAttempt.correct}</div>
                            <div class="text-xs text-gray-500">맞힌 개수</div>
                          </div>
                          <div class="text-center">
                            <div class="text-lg font-bold text-red-400">${lastAttempt.total - lastAttempt.correct}</div>
                            <div class="text-xs text-gray-500">틀린 개수</div>
                          </div>
                          <div class="text-center">
                            <div class="text-lg font-bold text-blue-400">${themeAttempts.length}</div>
                            <div class="text-xs text-gray-500">시도 횟수</div>
                          </div>
                        </div>

                        ${allWrongQuestions.length > 0 ? `
                          <div class="bg-red-900/20 border border-red-500/30 rounded-xl p-4">
                            <h4 class="text-sm font-bold text-red-400 mb-3 flex items-center">
                              ${icon('xCircle', 'mr-2', 18)}틀린 문제 목록
                            </h4>
                            <div class="space-y-2">
                              ${allWrongQuestions.map((wrongQ, idx) => `
                                <div class="text-sm bg-gray-900/50 rounded-lg p-3 border border-red-500/20">
                                  <p class="text-red-300 font-medium leading-relaxed">${idx + 1}. ${wrongQ}</p>
                                </div>
                              `).join('')}
                            </div>
                          </div>
                        ` : `
                          <div class="bg-green-900/20 border border-green-500/30 rounded-xl p-4 text-center">
                            <p class="text-green-400 text-sm font-bold">
                              ${icon('checkCircle', 'inline mr-2', 18)}모든 문제를 맞혔습니다!
                            </p>
                          </div>
                        `}
                      </div>
                    `;
                  }).join('');
                })()}
              </div>
            `}
          </div>
        </div>
      `;

      document.getElementById('backBtn').addEventListener('click', () => {
        state.selectedStudent = null;
        render();
      });

      // 퇴원 처리 버튼
      const withdrawBtn = document.getElementById('withdrawBtn');
      if (withdrawBtn) {
        withdrawBtn.addEventListener('click', async () => {
          if (confirm(`${student.studentName} 학생을 퇴원 처리하시겠습니까?\\n\\n퇴원생으로 이동하며, 나중에 재원 처리할 수 있습니다.`)) {
            try {
              await db.collection('students').doc(student.id).update({
                status: 'withdrawn',
                withdrawnAt: new Date().toISOString()
              });
              alert('퇴원 처리가 완료되었습니다.');
              
              // 상태 업데이트
              student.status = 'withdrawn';
              state.studentStatusFilter = 'withdrawn';
              state.selectedStudent = null;
              
              // 데이터 새로고침
              await loadAdminData(state.adminName);
              render();
            } catch (error) {
              console.error('퇴원 처리 오류:', error);
              alert('퇴원 처리 중 오류가 발생했습니다.');
            }
          }
        });
      }

      // 재원 처리 버튼
      const reactivateBtn = document.getElementById('reactivateBtn');
      if (reactivateBtn) {
        reactivateBtn.addEventListener('click', async () => {
          if (confirm(`${student.studentName} 학생을 재원 처리하시겠습니까?\n\n재원생 목록으로 이동합니다.`)) {
            try {
              await db.collection('students').doc(student.id).update({
                status: 'active',
                reactivatedAt: new Date().toISOString()
              });
              alert('재원 처리가 완료되었습니다.');
              
              // 상태 업데이트
              student.status = 'active';
              state.studentStatusFilter = 'active';
              state.selectedStudent = null;
              
              // 데이터 새로고침
              await loadAdminData(state.adminName);
              render();
            } catch (error) {
              console.error('재원 처리 오류:', error);
              alert('재원 처리 중 오류가 발생했습니다.');
            }
          }
        });
      }
    }

    function renderMainScreen() {
      const app = document.getElementById('app');
      const currentStudentAttempts = state.allStudentData[state.studentName]?.attempts || [];

      if (state.showResults) {
        renderResultsScreen(app, currentStudentAttempts);
        return;
      }

      if (!state.selectedCategory) {
        renderCategorySelection(app);
        return;
      }

      if (state.currentTheme === null) {
        renderThemeSelection(app);
        return;
      }

      renderQuizScreen(app);
    }

    function renderCategorySelection(app) {
      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="bg-gray-900 rounded-2xl p-6 mb-8 shadow-xl border border-orange-500/30">
              <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                  ${icon('user', 'text-white')}
                </div>
                <h2 class="text-xl font-bold text-white">${state.studentName}</h2>
              </div>
              <div class="flex gap-2">
                <button id="recordBtn" class="flex items-center px-5 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white transition-all border border-gray-700 transform hover:scale-105 active:scale-95">
                  ${icon('barChart', 'mr-2', 18)}학습 기록
                </button>
                <button id="logoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95 text-sm">
                  로그아웃
                </button>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              ${categories.map(category => `
                <button
                  data-cat="${category.id}"
                  class="cat-btn bg-gray-900 rounded-2xl p-6 border shadow-xl text-left transition-all transform ${
                    category.chapters.length > 0
                      ? 'border-gray-800 hover:shadow-orange-500/20 hover:border-orange-500/50 hover:scale-105 active:scale-95'
                      : 'border-gray-800 opacity-50 cursor-not-allowed'
                  }"
                  ${category.chapters.length === 0 ? 'disabled' : ''}
                >
                  <h3 class="text-base font-bold text-white mb-2">${category.name}</h3>
                  <p class="text-xs text-gray-500 font-semibold">
                    ${category.chapters.length > 0 ? `${category.chapters.length}개의 테마` : '준비 중'}
                  </p>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      document.getElementById('recordBtn').addEventListener('click', () => {
        state.showResults = true;
        state.recordSelectedCategory = null; // Chapter 선택 화면을 먼저 보여주기 위해 초기화
        render();
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        if (confirm('로그아웃 하시겠습니까?')) {
          logout();
        }
      });

      document.querySelectorAll('.cat-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = parseInt(btn.dataset.cat);
          const category = categories.find(c => c.id === catId);
          if (category && category.chapters && category.chapters.length > 0) {
            state.selectedCategory = catId;
            render();
          }
        });
      });
    }

    function renderThemeSelection(app) {
      const category = categories.find(c => c.id === state.selectedCategory);
      
      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="mb-4">
              <button id="backBtn" class="text-sm text-orange-500 hover:text-orange-400 flex items-center font-semibold">
                ${icon('chevronLeft', '', 16)}챕터 선택으로 돌아가기
              </button>
            </div>

            <div class="bg-gray-900 rounded-2xl p-6 mb-8 shadow-xl border border-orange-500/30">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h2 class="text-xl font-bold text-white">${category.name}</h2>
                  <p class="text-sm text-gray-400 mt-1 font-medium">테마 선택</p>
                </div>
                <button id="resultsBtn" class="flex items-center px-5 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white transition-all border border-gray-700 transform hover:scale-105 active:scale-95">
                  ${icon('barChart', 'mr-2', 18)}학습 기록
                </button>
              </div>
              
              ${category.chapterInfo ? `
                <div class="mt-4 pt-4 border-t border-gray-700">
                  <div class="grid grid-cols-2 gap-3">
                    ${category.chapterInfo.map(info => `
                      <div class="bg-gray-800/50 rounded-lg p-3 border border-gray-700">
                        <div class="flex items-baseline gap-2 mb-1">
                          <span class="text-orange-400 font-bold text-xs">${info.partName}</span>
                          <span class="text-gray-300 text-xs font-medium">${info.description}</span>
                        </div>
                        <span class="text-gray-500 text-xs">${info.range}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              ${category.chapters.map(theme => {
                const status = getThemeStatus(state.selectedCategory, theme.id);
                const locked = isLocked(state.selectedCategory, theme.id);
                const remainingSeconds = getRemainingTime(state.selectedCategory, theme.id);
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                const isCompleted = status.status === 'completed';

                return `
                  <div class="bg-gray-900 rounded-2xl p-6 shadow-xl transition-all relative ${
                    isCompleted 
                      ? 'border-2 border-green-500/50 shadow-green-500/20' 
                      : 'border border-gray-800 hover:shadow-orange-500/20 hover:border-orange-500/50'
                  }">
                    ${isCompleted ? `
                      <div class="absolute top-4 right-4 flex items-center justify-center" style="width: 28px; height: 28px;">
                        <svg style="width:28px;height:28px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-500">
                          <circle cx="12" cy="8" r="7"/>
                          <path d="M8.21 13.89 7 23l5-3 5 3-1.21-9.12"/>
                        </svg>
                      </div>
                    ` : ''}
                    
                    <div class="flex items-start justify-between mb-4">
                      <h3 class="text-base font-bold text-white flex-1 pr-8">${theme.name}</h3>
                    </div>
                    
                    <p class="text-xs text-gray-500 mb-4 font-semibold">${theme.questions.length}개 문제</p>
                    
                    ${status.lastAttempt ? `
                      <div class="mb-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <p class="text-xs text-gray-500 font-semibold mb-1">최근 시도</p>
                        <p class="text-lg font-bold text-orange-400">
                          ${status.lastAttempt.percentage}% <span class="text-sm text-gray-500">(${status.lastAttempt.correct}/${status.lastAttempt.total})</span>
                        </p>
                        <p class="text-xs text-gray-500 mt-1">시도 횟수: ${status.attemptCount}회</p>
                      </div>
                    ` : ''}

                    ${isCompleted ? `
                      <div class="space-y-2">
                        <div class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 rounded-xl font-bold text-white text-center flex items-center justify-center text-sm shadow-lg shadow-green-500/30">
                          ${icon('checkCircle', 'mr-2', 18)}퀴즈 완료
                        </div>
                        <button data-theme="${theme.id}" class="start-btn w-full py-2 bg-gray-800 hover:bg-gray-700 rounded-xl font-semibold text-white transition-all text-xs border border-gray-700 transform hover:scale-105 active:scale-95">
                          다시 도전하기
                        </button>
                      </div>
                    ` : locked ? `
                      <div class="space-y-3">
                        <div class="w-full py-3 bg-gray-800/50 rounded-xl font-bold text-gray-400 text-center border border-gray-700 cursor-not-allowed flex items-center justify-center text-sm">
                          ${icon('lock', 'mr-2', 16)}${icon('clock', 'mr-1', 16)}<span data-lock-timer="${theme.id}">${minutes}:${seconds.toString().padStart(2, '0')} 후 재시험 가능</span>
                        </div>
                        <button data-review="${theme.id}" class="review-btn w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-xl font-bold text-white transition-all text-sm shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 transform hover:scale-105 active:scale-95 flex items-center justify-center">
                          ${icon('bookOpen', 'mr-2', 18)}복습하기
                        </button>
                      </div>
                    ` : status.status === 'retry' ? `
                      <button data-theme="${theme.id}" class="start-btn w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all text-sm shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95">
                        퀴즈 다시 도전하기
                      </button>
                    ` : `
                      <button data-theme="${theme.id}" class="start-btn w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all text-sm shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95">
                        퀴즈 시작
                      </button>
                    `}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;

      document.getElementById('backBtn').addEventListener('click', () => {
        state.selectedCategory = null;
        render();
      });

      document.getElementById('resultsBtn').addEventListener('click', () => {
        state.showResults = true;
        state.recordSelectedCategory = state.selectedCategory; // 현재 선택된 카테고리를 학습 기록용으로 설정
        render();
      });

      document.querySelectorAll('.start-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          handleStartQuiz(parseInt(btn.dataset.theme));
        });
      });

      document.querySelectorAll('.review-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.showResults = true;
          state.recordSelectedCategory = state.selectedCategory;
          render();
        });
      });
    }

    function renderQuizScreen(app) {
      const category = categories.find(c => c.id === state.selectedCategory);
      if (!category || !category.chapters) {
        app.innerHTML = `<div class="min-h-screen flex items-center justify-center p-6"><p class="text-white">카테고리를 찾을 수 없습니다.</p></div>`;
        return;
      }
      
      const theme = category.chapters.find(t => t.id === state.currentTheme);
      if (!theme || !theme.questions) {
        app.innerHTML = `<div class="min-h-screen flex items-center justify-center p-6"><p class="text-white">테마를 찾을 수 없습니다.</p></div>`;
        return;
      }
      
      const question = theme.questions[state.currentQuestion];
      const answer = state.answers[state.currentQuestion];
      const answeredCount = Object.keys(state.answers).length;
      const correctCount = Object.values(state.answers).filter(a => a.correct).length;
      const incorrectCount = answeredCount - correctCount;
      const isComplete = answeredCount === theme.questions.length;

      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-4xl mx-auto">
            <div class="mb-4">
              <button id="backToThemeBtn" class="text-sm text-orange-500 hover:text-orange-400 flex items-center font-semibold">
                ${icon('chevronLeft', '', 16)}테마 선택으로 돌아가기
              </button>
            </div>

            <div class="bg-gray-900 rounded-2xl p-5 mb-6 shadow-xl border border-orange-500/30">
              <div class="flex items-center justify-between">
                <div>
                  <h2 class="text-base font-bold text-white">${state.studentName}</h2>
                  <p class="text-xs text-gray-400 mt-1 font-medium">${theme.name}</p>
                </div>
                <div class="text-right">
                  <p class="text-xs text-gray-500 font-semibold">진행 상황</p>
                  <p class="text-lg font-bold text-orange-400">${state.currentQuestion + 1} / ${theme.questions.length}</p>
                </div>
              </div>
            </div>

            <div class="bg-gray-900 rounded-2xl p-6 mb-6 shadow-xl border border-gray-800">
              <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div class="text-2xl font-bold text-green-400">${correctCount}</div>
                  <div class="text-xs text-gray-500 mt-1 font-medium">맞힌 개수</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-red-400">${incorrectCount}</div>
                  <div class="text-xs text-gray-500 mt-1 font-medium">틀린 개수</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-orange-400">${answeredCount}</div>
                  <div class="text-xs text-gray-500 mt-1 font-medium">답변 완료</div>
                </div>
              </div>
            </div>

            <div class="bg-gradient-to-r from-orange-900/30 to-red-900/30 rounded-2xl p-4 mb-6 shadow-xl border-2 ${state.timerExpired ? 'border-red-500' : state.questionTimer <= 30 ? 'border-red-400' : 'border-orange-500/30'}">
              <div class="flex items-center justify-center gap-2">
                <div id="questionTimer" class="text-2xl font-bold"></div>
              </div>
            </div>

            <div class="bg-gray-900 rounded-2xl p-8 border border-gray-800 shadow-xl mb-6">
              <div class="mb-8">
                <span class="inline-block px-3 py-1 bg-orange-500/20 text-orange-400 rounded-lg text-xs font-bold mb-4">
                  문제 ${state.currentQuestion + 1}
                </span>
                <p class="text-lg leading-relaxed text-white font-medium">${question.question}</p>
              </div>
              
              <div class="flex gap-3 mb-6">
                ${['O', 'X'].map(opt => {
                  let btnClass = 'flex-1 py-4 px-6 rounded-xl font-bold text-2xl transition-all transform ';
                  
                  if (!answer) {
                    btnClass += 'bg-gray-800 hover:bg-gray-700 border-2 border-gray-700 text-white hover:scale-105 active:scale-95 cursor-pointer';
                  } else {
                    if (answer.selected === opt) {
                      if (answer.correct) {
                        btnClass += 'bg-gradient-to-r from-green-500 to-green-600 border-2 border-green-400 text-white shadow-lg shadow-green-500/50';
                      } else {
                        btnClass += 'bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 text-white shadow-lg shadow-red-500/50';
                      }
                    } else if (question.answer === opt) {
                      btnClass += 'bg-gradient-to-r from-green-500 to-green-600 border-2 border-green-400 text-white shadow-lg shadow-green-500/50';
                    } else {
                      btnClass += 'bg-gray-800/30 border-2 border-gray-700 opacity-40 text-gray-600';
                    }
                    btnClass += ' cursor-not-allowed';
                  }

                  return `
                    <button data-answer="${opt}" class="answer-btn ${btnClass}">
                      ${answer?.selected === opt ? (answer.correct ? icon('checkCircle', 'inline mr-2', 22) : icon('xCircle', 'inline mr-2', 22)) : ''}
                      ${opt}
                    </button>
                  `;
                }).join('')}
              </div>
              
              ${answer ? `
                <div class="p-5 rounded-xl border-2 ${answer.correct ? 'bg-green-900/20 border-green-500/50' : 'bg-red-900/20 border-red-500/50'}">
                  <p class="font-bold text-sm mb-3" style="color: ${answer.correct ? '#4ade80' : '#f87171'}">
                    ${answer.correct ? '✓ 정답입니다!' : '✗ 오답입니다.'}
                  </p>
                  <div class="mt-3">
                    <label class="text-sm text-gray-300 font-bold mb-2 block">📝 선생님 메모:</label>
                    <textarea
                      id="teacherNote-${state.currentQuestion}"
                      class="w-full p-3 bg-gray-900/50 border border-gray-700 rounded-lg text-sm text-gray-300 focus:border-orange-500 focus:outline-none resize-none"
                      rows="3"
                      placeholder="이 문제에 대한 메모를 입력하세요..."
                    >${state.teacherNotes?.[state.currentTheme]?.[state.currentQuestion] || ''}</textarea>
                  </div>
                </div>
              ` : ''}
            </div>

            <div class="flex gap-3">
              <button id="prevBtn" class="flex items-center px-5 py-3 bg-gray-800 hover:bg-gray-700 disabled:bg-gray-800/30 disabled:cursor-not-allowed rounded-xl font-bold transition-all border border-gray-700 disabled:border-gray-800 text-white disabled:text-gray-600 text-sm transform hover:scale-105 active:scale-95 disabled:scale-100" ${state.currentQuestion === 0 ? 'disabled' : ''}>
                ${icon('chevronLeft', 'mr-1', 18)}이전
              </button>
              
              ${state.currentQuestion < theme.questions.length - 1 ? `
                <button id="nextBtn" class="flex-1 flex items-center justify-center px-5 py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold transition-all text-white text-sm shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95">
                  다음${icon('chevronRight', 'ml-1', 18)}
                </button>
              ` : `
                <button id="finishBtn" class="flex-1 px-5 py-3 rounded-xl font-bold transition-all text-sm transform ${
                  isComplete
                    ? correctCount === theme.questions.length
                      ? 'bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white shadow-lg shadow-green-500/30 hover:scale-105 active:scale-95'
                      : 'bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white shadow-lg shadow-orange-500/30 hover:scale-105 active:scale-95'
                    : 'bg-gray-800/30 cursor-not-allowed border border-gray-700 text-gray-600 scale-100'
                }" ${!isComplete ? 'disabled' : ''}>
                  ${isComplete ? '결과 저장하고 완료' : '모든 문제를 풀어주세요'}
                </button>
              `}
            </div>

            ${isComplete ? `
              <div class="mt-6 border-2 rounded-2xl p-6 shadow-xl ${
                correctCount === theme.questions.length 
                  ? 'bg-green-900/20 border-green-500/50' 
                  : 'bg-orange-900/20 border-orange-500/50'
              }">
                <h3 class="text-xl font-bold mb-4 text-center ${
                  correctCount === theme.questions.length ? 'text-green-400' : 'text-orange-400'
                }">
                  ${correctCount === theme.questions.length ? '🎉 완벽합니다!' : '퀴즈 완료!'}
                </h3>
                <p class="text-base text-center mb-3 text-white font-medium">
                  총 ${theme.questions.length}문제 중 <span class="text-green-400 font-bold">${correctCount}문제</span> 맞히셨습니다!
                </p>
                <p class="text-sm text-center mb-4 text-gray-300 font-medium">
                  정답률: <span class="font-bold text-lg ${
                    correctCount === theme.questions.length ? 'text-green-400' : 'text-orange-400'
                  }">
                    ${Math.round((correctCount / theme.questions.length) * 100)}%
                  </span>
                </p>
                ${correctCount < theme.questions.length ? `
                  <p class="text-center text-xs text-gray-400 font-medium">
                    💡 1분 후 재도전 가능. 힌트를 복습하세요!
                  </p>
                ` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;

      document.getElementById('backToThemeBtn').addEventListener('click', () => {
        stopQuestionTimer();
        state.currentTheme = null;
        state.currentQuestion = 0;
        state.answers = {};
        render();
      });

      if (state.currentQuestion > 0) {
        document.getElementById('prevBtn').addEventListener('click', handlePrev);
      }

      if (state.currentQuestion < theme.questions.length - 1) {
        document.getElementById('nextBtn').addEventListener('click', handleNext);
      } else {
        const finishBtn = document.getElementById('finishBtn');
        if (finishBtn && isComplete) {
          finishBtn.addEventListener('click', async () => {
            console.log('완료 버튼 클릭됨');
            finishBtn.disabled = true;
            finishBtn.textContent = '저장 중...';
            try {
              await handleFinishQuiz();
            } catch (error) {
              console.error('완료 처리 오류:', error);
              alert('오류 발생: ' + error.message);
              finishBtn.disabled = false;
              finishBtn.textContent = '결과 저장하고 완료';
            }
          });
        }
      }

      if (!answer) {
        document.querySelectorAll('.answer-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            handleAnswer(btn.dataset.answer);
          });
        });
      }

      // 선생님 메모 저장
      const teacherNoteTextarea = document.getElementById(`teacherNote-${state.currentQuestion}`);
      if (teacherNoteTextarea) {
        teacherNoteTextarea.addEventListener('input', (e) => {
          if (!state.teacherNotes[state.currentTheme]) {
            state.teacherNotes[state.currentTheme] = {};
          }
          state.teacherNotes[state.currentTheme][state.currentQuestion] = e.target.value;
        });
      }

      // 타이머 표시 업데이트
      updateTimerDisplay();
    }

    function renderResultsScreen(app, currentStudentAttempts) {
      const categoryAttempts = state.recordSelectedCategory 
        ? currentStudentAttempts.filter(a => a.categoryId === state.recordSelectedCategory)
        : [];

      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="bg-gray-900 rounded-2xl p-6 mb-6 shadow-xl border border-orange-500/30">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                    ${icon('user', 'text-white')}
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-white">${state.studentName}</h2>
                    <p class="text-sm text-gray-400">학습 기록</p>
                  </div>
                </div>
                <button id="backBtn" class="px-5 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white transition-all border border-gray-700 transform hover:scale-105 active:scale-95">
                  돌아가기
                </button>
              </div>
            </div>

            ${state.recordSelectedCategory ? `
              <div class="mb-4">
                <button id="allRecordsBtn" class="text-sm text-orange-500 hover:text-orange-400 flex items-center font-semibold">
                  ${icon('chevronLeft', '', 16)}챕터 선택으로 돌아가기
                </button>
              </div>
              
              <h3 class="text-lg font-bold text-white mb-4">
                ${categories.find(c => c.id === state.recordSelectedCategory)?.name}
              </h3>

              ${categoryAttempts.length === 0 ? `
                <div class="bg-gray-900 rounded-2xl p-12 text-center border border-gray-800">
                  ${icon('barChart', 'mx-auto mb-4 text-gray-600', 48)}
                  <p class="text-gray-400 font-medium">이 챕터의 학습 기록이 없습니다.</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${(() => {
                    // Theme별로 그룹화 (themeId 기준으로 정렬)
                    const themeGroups = {};
                    categoryAttempts.forEach(attempt => {
                      const key = attempt.themeId;
                      if (!themeGroups[key]) {
                        themeGroups[key] = [];
                      }
                      themeGroups[key].push(attempt);
                    });

                    // themeId 순서대로 정렬
                    const sortedThemeIds = Object.keys(themeGroups).map(Number).sort((a, b) => a - b);

                    return sortedThemeIds.map(themeId => {
                      const attempts = themeGroups[themeId];
                      if (!attempts || attempts.length === 0) return '';
                      const lastAttempt = attempts[attempts.length - 1];
                      const allWrongQuestions = attempts
                        .flatMap(a => a.wrongQuestions || [])
                        .filter((q, idx, arr) => arr.indexOf(q) === idx);

                      const isRetakeAvailable = lastAttempt.percentage < 100;
                      const category = categories.find(c => c.id === lastAttempt.categoryId);
                      const theme = category?.chapters?.find(t => t.id === lastAttempt.themeId);

                      // theme나 questions가 없으면 기본 정보만 표시
                      if (!theme || !theme.questions) {
                        return `
                          <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-xl relative">
                            <div class="flex justify-between items-start mb-4">
                              <div>
                                <h3 class="text-base font-bold text-white mb-1">${lastAttempt.themeName}</h3>
                                <p class="text-xs text-gray-500">최종 시도: ${lastAttempt.date}</p>
                              </div>
                              <div class="text-right">
                                <div class="text-2xl font-bold ${lastAttempt.percentage === 100 ? 'text-green-400' : 'text-orange-400'}">
                                  ${lastAttempt.percentage}%
                                </div>
                                <div class="text-xs text-gray-500 font-semibold">${lastAttempt.correct} / ${lastAttempt.total}</div>
                              </div>
                            </div>
                            <p class="text-gray-400 text-sm">문제 정보를 불러올 수 없습니다.</p>
                          </div>
                        `;
                      }

                      return `
                        <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-xl relative">
                          <div class="flex justify-between items-start mb-4">
                            <div>
                              <h3 class="text-base font-bold text-white mb-1">${lastAttempt.themeName}</h3>
                              <p class="text-xs text-gray-500">최종 시도: ${lastAttempt.date}</p>
                            </div>
                            <div class="text-right">
                              <div class="text-2xl font-bold ${lastAttempt.percentage === 100 ? 'text-green-400' : 'text-orange-400'}">
                                ${lastAttempt.percentage}%
                              </div>
                              <div class="text-xs text-gray-500 font-semibold">${lastAttempt.correct} / ${lastAttempt.total}</div>
                            </div>
                          </div>
                          
                          <div class="grid grid-cols-3 gap-4 pt-4 border-t border-gray-800 mb-4">
                            <div class="text-center">
                              <div class="text-lg font-bold text-green-400">${lastAttempt.correct}</div>
                              <div class="text-xs text-gray-500">맞힌 개수</div>
                            </div>
                            <div class="text-center">
                              <div class="text-lg font-bold text-red-400">${lastAttempt.total - lastAttempt.correct}</div>
                              <div class="text-xs text-gray-500">틀린 개수</div>
                            </div>
                            <div class="text-center">
                              <div class="text-lg font-bold text-blue-400">${attempts.length}</div>
                              <div class="text-xs text-gray-500">시도 횟수</div>
                            </div>
                          </div>

                          ${isRetakeAvailable ? `
                            <button 
                              data-category="${lastAttempt.categoryId}" 
                              data-theme="${lastAttempt.themeId}" 
                              class="retake-btn w-full mb-4 px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all transform hover:scale-105 active:scale-95 shadow-lg shadow-orange-500/30"
                            >
                              🔥 재시험 도전하기
                            </button>
                          ` : `
                            <div class="mb-4 px-6 py-3 bg-green-900/20 border border-green-500/30 rounded-xl text-center">
                              <p class="text-green-400 font-bold text-sm flex items-center justify-center gap-2">
                                ${icon('checkCircle', '', 18)}
                                완벽하게 마스터했습니다!
                              </p>
                            </div>
                          `}

                          <div class="bg-gray-900/20 border border-gray-700 rounded-xl p-4">
                            <h4 class="text-sm font-bold text-white mb-3 flex items-center flex-wrap gap-2">
                              <span class="flex items-center">
                                ${icon('bookOpen', 'mr-2', 18)}모든 문제 복습
                              </span>
                            </h4>
                            <div class="space-y-3">
                              ${theme.questions.map((q, questionIndex) => {
                                const isWrong = allWrongQuestions.includes(q.question);
                                const teacherNote = state.teacherNotes?.[theme.id]?.[questionIndex];
                                return `
                                  <div class="text-sm bg-gray-900/50 rounded-lg p-3 border ${isWrong ? 'border-red-500/30' : 'border-green-500/30'}">
                                    <div class="flex items-start gap-2 mb-2">
                                      ${isWrong
                                        ? `<span class="text-red-400 font-bold flex-shrink-0">✗</span>`
                                        : `<span class="text-green-400 font-bold flex-shrink-0">✓</span>`
                                      }
                                      <p class="${isWrong ? 'text-red-300' : 'text-green-300'} font-medium leading-relaxed">${q.question}</p>
                                    </div>
                                    ${teacherNote ? `
                                      <p class="text-gray-400 text-xs leading-relaxed mt-2 p-2 bg-gray-800/50 rounded ml-6">
                                        <span class="text-blue-400 font-bold">📝 선생님 메모:</span> ${teacherNote}
                                      </p>
                                    ` : ''}
                                  </div>
                                `;
                              }).join('')}
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('');
                  })()}
                </div>
              `}
            ` : currentStudentAttempts.length === 0 ? `
              <div class="bg-gray-900 rounded-2xl p-12 text-center border border-gray-800">
                ${icon('barChart', 'mx-auto mb-4 text-gray-600', 48)}
                <p class="text-gray-400 font-medium">아직 학습 기록이 없습니다.</p>
              </div>
            ` : `
              <div class="grid md:grid-cols-2 gap-4">
                ${categories.filter(cat => currentStudentAttempts.some(a => a.categoryId === cat.id)).map((cat) => {
                  const catAttempts = currentStudentAttempts.filter(a => a.categoryId === cat.id);
                  const avgPercentage = Math.round(catAttempts.reduce((sum, a) => sum + a.percentage, 0) / catAttempts.length);
                  
                  return `
                    <button data-cat="${cat.id}" class="cat-record-btn bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-xl hover:shadow-orange-500/20 hover:border-orange-500/50 transition-all text-left transform hover:scale-105 active:scale-95">
                      <h3 class="text-base font-bold text-white mb-2">${cat.name}</h3>
                      <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 font-semibold">평균 정답률</span>
                        <span class="text-lg font-bold text-orange-400">${avgPercentage}%</span>
                      </div>
                      <div class="text-xs text-gray-500 mt-2 font-medium">
                        시도 횟수: ${catAttempts.length}회
                      </div>
                    </button>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        </div>
      `;

      document.getElementById('backBtn').addEventListener('click', () => {
        state.showResults = false;
        state.recordSelectedCategory = null; // 초기화
        render();
      });

      if (state.recordSelectedCategory) {
        const allRecordsBtn = document.getElementById('allRecordsBtn');
        if (allRecordsBtn) {
          allRecordsBtn.addEventListener('click', () => {
            state.recordSelectedCategory = null;
            render();
          });
        }

        // 재시험 버튼 이벤트 리스너
        document.querySelectorAll('.retake-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const categoryId = parseInt(btn.dataset.category);
            const themeId = parseInt(btn.dataset.theme);
            
            // 재시험 시작
            state.showResults = false;
            state.selectedCategory = categoryId;
            state.currentTheme = themeId;
            state.currentQuestion = 0;
            state.answers = {};
            render();
          });
        });
      } else {
        document.querySelectorAll('.cat-record-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            state.recordSelectedCategory = parseInt(btn.dataset.cat);
            render();
          });
        });
      }
    }

    // 온라인/오프라인 이벤트
    window.addEventListener('online', async () => {
      console.log('온라인 복구됨! 동기화 시작...');
      await syncPendingData();
    });

    window.addEventListener('offline', () => {
      console.log('오프라인 모드');
      alert('오프라인 상태입니다. 데이터는 로컬에 저장되며 온라인 복구 시 자동 동기화됩니다.');
    });

    // 타이머 시작
    setInterval(() => {
      state.currentTime = Date.now();
      
      document.querySelectorAll('[data-lock-timer]').forEach(element => {
        const themeId = parseInt(element.getAttribute('data-lock-timer'));
        if (isLocked(state.selectedCategory, themeId)) {
          const remainingSeconds = getRemainingTime(state.selectedCategory, themeId);
          const minutes = Math.floor(remainingSeconds / 60);
          const seconds = remainingSeconds % 60;
          element.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} 후 재시험 가능`;
        } else {
          render();
        }
      });
    }, 1000);

    // 앱 초기화
    (async function initApp() {
      await initIndexedDB();
      
      const autoLoginInfo = checkAutoLogin();
      if (autoLoginInfo) {
        console.log('자동 로그인 실행:', autoLoginInfo.type);
        
        if (autoLoginInfo.type === 'student') {
          // 학생 자동 로그인
          state.loading = true;
          render();
          
          try {
            const p = state.phone.replace(/[^0-9]/g, '');
            const id = `${state.studentName.trim()}_${p}`;
            state.uid = id;
            
            await loadData(id);
            
            // 퇴원생 체크
            const studentData = state.allStudentData[state.studentName];
            if (studentData && studentData.status === 'withdrawn') {
              state.loading = false;
              alert('퇴원 처리된 학생은 로그인할 수 없습니다.\n담당 선생님께 문의해주세요.');
              logout();
              return;
            }
            
            state.isLoggedIn = true;
            state.userType = 'student';
            state.loading = false;
            render();
          } catch (error) {
            console.error('학생 자동 로그인 오류:', error);
            state.loading = false;
            alert('자동 로그인 중 오류가 발생했습니다.');
            logout();
          }
        } else if (autoLoginInfo.type === 'admin') {
          // 관리자 자동 로그인
          state.loading = true;
          render();
          
          try {
            await loadAdminStudents(autoLoginInfo.name);
            state.isLoggedIn = true;
            state.userType = 'admin';
            state.loading = false;
            render();
          } catch (error) {
            console.error('관리자 자동 로그인 오류:', error);
            state.loading = false;
            alert('자동 로그인 중 오류가 발생했습니다.');
            logout();
          }
        }
      } else {
        render();
      }
      
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('Service Worker 등록 성공:', registration.scope);
          })
          .catch(error => {
            console.log('Service Worker 등록 실패:', error);
          });
      }
    })();
  </script>
</body>
</html>